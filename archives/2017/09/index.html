<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  <title>Archives: 2017/9 | PIVIX</title>
  <meta name="description" content="A minimal hexo theme." />
  <meta name="keywords" content="hexo,theme,typescript,otakism,otaku" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="PIVIX">
<meta property="og:url" content="https://lemonoilP.github.io/archives/2017/09/index.html">
<meta property="og:site_name" content="PIVIX">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="PIVIX">
  
  
    <link rel="icon" href="/favicon.png">
  

	<script src="https://use.typekit.net/eyf3hir.js"></script>
  <script>try{Typekit.load({ async: false });}catch(e){}</script>
  <link rel="stylesheet" href="/style.css">
  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>
  

</head>

<body>
  
  <div id="loading-bar-wrapper">
  <div id="loading-bar"></div>
</div>

  <script>setLoadingBarProgress(20)</script>
  
  <div id="site-wrapper">
    
    <header id="header">
	<div id="header-wrapper" class="clearfix">
		<a id="logo" href="/">
			<img src="/images/logo.png" />
			<span id="site-desc">
			  otaku keeps alive
      </span>
		</a>
		<button id="site-nav-switch">
	    <span class="icon icon-menu"></span>
	  </button>
	</div>
	<aside id="site-menu">
  	<nav>
  		
        <a href="/" class="nav-home nav">
          Home
        </a>
      
        <a href="/about" class="nav-about nav">
          About
        </a>
      
        <a href="/archives" class="nav-archives nav">
          Archives
        </a>
      
    </nav>
	</aside>
</header>
    <script>setLoadingBarProgress(40);</script>
    
    <main id="main" role="main">
      
	


	<section class="page-header archive">
    <h1>- <span>2017.9</span> -</h1>
  </section>




<section class="post-list">
	
    <article class="post no-title">

  
  <time>
    Sep 25, 2017
  </time>
  <section class="content">
	  <p>[toc]<br>本文会从链剖讲起，涉及其变形进阶，之后也会讲到DFS序，树上分块，块状树，点分治与边分治，LCT，仙人掌与仙人球，伪top_tree(AAA树)，top_tree。<br>本文重点讲述思维，至于例题虽会有涉及，但还是请读者自行百度（毕竟OI是不缺题的。。。。）<br>详略在文章中体现，如有错误，请各位读者指正。</p>
<h1 id="从树链剖分讲起"><a href="#从树链剖分讲起" class="headerlink" title="从树链剖分讲起"></a>从树链剖分讲起</h1><p>其实我是先会LCT，再会链剖的，所以说比较尴尬。。。<br>但是自我学习了链剖后，我发现链剖给予了树上操作无限的可能性。</p>
<h2 id="长链与重链"><a href="#长链与重链" class="headerlink" title="长链与重链"></a>长链与重链</h2><p>重链剖分在OI中很常见，所以这里只放出模板的博客：<br><a href="http://www.cnblogs.com/Sdchr/p/6357576.html" target="_blank" rel="external">感谢博主——Sdchr</a><br>长链剖分比较冷门，大部分使用在$O(1)$查询第k级祖先，与重链剖分相对的，就是把size的处理变为deep的处理。<br>这里也有份比较详细的blog： <a href="http://www.cnblogs.com/zzqsblog/articles/6700133.html" target="_blank" rel="external">感谢博主——ZZQ</a><br>这里的长链与重链的关系有些像平衡树中的重量平衡与深度平衡，各有特点，相互弥补在树上操作的不足。<br>重点即是重链与轻链的交替穿插，使得部分信息能够在树中快速上传，将树变得有序化，层次化就是树链剖分的本质。<br>长链剖分的题除上述提到外还有 BZOJ1785、BZOJ4543。<br>讲重点：<br>1.为什么要学树链剖分？<br>A:因为要考，lct的常数太大。链剖可以快速地与其他数据结构相关联，易出题。<br>2.如何学习链剖？<br>A:做题，做与其他数据结构、算法结合的题，特别是对于链剖在各类的树上运用。链剖模板很简单，但是如何运用是一个需要深度思考的问题。遇到链剖题千万不要裸上LCT水掉，当遇上卡常类、与一些高级算法结合类的题时就会无从下手。（说的就是blog主。。。）<br>3.学习链剖要到什么程度？<br>A:模板10~15min，重要的是快判断题目可以用链剖解决，并且知道如何解决（说白了，就是多刷点题）。</p>
<p>上干货（咦？长链剖分都不算干货？）<br>好吧。。补充长链剖分模板中的核心代码<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> fa[N],depth[N],Dep[N],top[N],son[N],dfn[N],cnt;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">dfs</span><span class="params">(<span class="keyword">int</span> u,<span class="keyword">int</span> f)</span></span>&#123;</div><div class="line">	Dep[u]=depth[u]=depth[fa]+<span class="number">1</span>,fa[u]=f;</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> p=head[u];p;p=G[p].next)</div><div class="line">		<span class="keyword">if</span>(V!=f)</div><div class="line">			dfs(V,u),Dep[u]=max(Dep[u],Dep[V]);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">ask</span><span class="params">(<span class="keyword">int</span> u,<span class="keyword">int</span> fa,<span class="keyword">int</span> z)</span></span>&#123;</div><div class="line">	dfn[u]=++cnt,top[u]=z,son[u]=<span class="number">0</span>;</div><div class="line">	<span class="keyword">int</span> maxv=<span class="number">0</span>;</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> p=head[u];p;p=G[p].next)</div><div class="line">		<span class="keyword">if</span>(V!=fa&amp;&amp;Dep[V]&gt;maxv)</div><div class="line">			maxv=Dep[son[u]=V];</div><div class="line">	<span class="keyword">if</span>(son[u])ask(son[u],u,z);</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> p=head[u];p;p=G[p].next)</div><div class="line">		<span class="keyword">if</span>(V!=fa&amp;&amp;V!=son[u])</div><div class="line">	ask(V,u,V);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>可以看见size不见了只多出来一个新的dep。剩下的就靠自己领悟了。</p>
<h2 id="合并！"><a href="#合并！" class="headerlink" title="合并！"></a>合并！</h2><p>从刘rj的紫书上看到了有关树链剖分的合并，详情可以参考<br><a href="http://www.cnblogs.com/idy002/p/4563611.html" target="_blank" rel="external">%%%——idy002</a>学长大佬。<br>有序链剖概念的提出给予我们一扇新世界的大门<br><a href="http://blog.csdn.net/lemonoil/article/details/63262360" target="_blank" rel="external">见例题T3</a><br>link操作神来之笔，但是反过来说，难道寻常链剖做不到有序吗？不见得吧，用if特判或者再建立一棵倒着的树链剖分不就可以了吗?方法有很多不见得固定死思维，只要算法有正确性，复杂度合适，那么勇敢创新是值得借鉴的。</p>
<h2 id="tips"><a href="#tips" class="headerlink" title="tips"></a>tips</h2><p>链剖小技巧：<br>1.求LCA，虽然理论复杂度比倍增高，但是实际效果令人满意，链剖的理论常数基本不大于1，实际贴近于\(\frac{1}{2}\),所以LCA用它在线查询是很不错的。<br>2.长链、重链一起上，反正都要用到dfs序，而且步骤也简单只需追加一个数组即可，当你无法判定是重链还是长链时，这样很稳。</p>
<p>一般来说，裸的链剖是考不出什么花样的，所以学会套用数据结构才是灵活掌握链剖的表现。</p>
<h2 id="过渡Ⅰ"><a href="#过渡Ⅰ" class="headerlink" title="过渡Ⅰ"></a>过渡Ⅰ</h2><p>链剖就这样结束了吧，毕竟大家都有过了解，并且也都学习过，接下来是一道裸题，轻喷。<br><a href="http://www.lydsy.com/JudgeOnline/problem.php?id=1036" target="_blank" rel="external">BZOJ1036</a><br>没错，是一道已经做烂的经典题目，什么树链剖分+线段树就可以快速水过，详情请见hzwer（%%%）的代码，里面还有一份很清新的LCT的方法，这些都是极好的。<br>接下来，就是重点。为什么博主谈到了这道题，那是因为与接下来的块状树有关。</p>
<h1 id="块状树（优秀的暴力）"><a href="#块状树（优秀的暴力）" class="headerlink" title="块状树（优秀的暴力）"></a>块状树（优秀的暴力）</h1><p>一般谈到块状树，例题举例便是<strong>Gty的超级妹子树</strong>之类的，会使人感觉块状树引用范围太少，比不上链剖（虽然这是事实），块状树的应用实际上过更加广泛，更加灵活。<br>所以上面那道BZOJ1036便是一个例子。<br>这次不矫情，直接上code：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*************************************************</span></div><div class="line"><span class="comment">    Problem: 1036</span></div><div class="line"><span class="comment">    User: lemonoil</span></div><div class="line"><span class="comment">    Language: C++</span></div><div class="line"><span class="comment">    Result: Accepted</span></div><div class="line"><span class="comment">    Time:2852 ms</span></div><div class="line"><span class="comment">    Memory:4512 kb</span></div><div class="line"><span class="comment">****************************************************/</span></div><div class="line"> </div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;algorithm&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstdio&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cmath&gt;</span></span></div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> maxn=<span class="number">30000</span>,inf=~<span class="number">0U</span>&gt;&gt;<span class="number">1</span>;</div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="keyword">char</span> cmd[<span class="number">10</span>];</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">data</span>&#123;</span></div><div class="line">    <span class="keyword">int</span> to,next;</div><div class="line">&#125;E[maxn&lt;&lt;<span class="number">1</span>],Et[maxn&lt;&lt;<span class="number">1</span>];</div><div class="line"><span class="keyword">int</span> n,q,s,t,x,y,w[maxn],sqrtn,deep[maxn],fa[maxn];</div><div class="line"><span class="keyword">int</span> belong[maxn],M[maxn],sz[maxn],head[maxn],tail[maxn],tot,cnt;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">addedge</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> y)</span></span>&#123;</div><div class="line">    E[++tot].to=y,E[tot].next=head[x],head[x]=tot;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> y)</span></span>&#123;</div><div class="line">    Et[++cnt].to=y,Et[cnt].next=tail[x],tail[x]=cnt;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfsf</span><span class="params">(<span class="keyword">int</span> t,<span class="keyword">int</span> f,<span class="keyword">int</span> d)</span></span>&#123;</div><div class="line">    deep[t]=d,fa[t]=f;</div><div class="line">    <span class="keyword">int</span> tmp=belong[t];</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">register</span> <span class="keyword">int</span> e=head[t];e;e=E[e].next)<span class="keyword">if</span>(E[e].to!=f)&#123;</div><div class="line">        <span class="keyword">if</span>(sz[tmp]++&lt;sqrtn)insert(t,E[e].to),belong[E[e].to]=tmp;</div><div class="line">        dfsf(E[e].to,t,d+<span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfss</span><span class="params">(<span class="keyword">int</span> t,<span class="keyword">int</span> s,<span class="keyword">int</span> m)</span></span>&#123;</div><div class="line">    sz[t]=s+=w[t];M[t]=m=max(m,w[t]);</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">register</span> <span class="keyword">int</span> e=tail[t];e;e=Et[e].next)dfss(Et[e].to,s,m);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">change</span><span class="params">(<span class="keyword">int</span> t,<span class="keyword">int</span> u)</span></span>&#123;</div><div class="line">    w[t]=u;</div><div class="line">    <span class="keyword">if</span>(t==belong[t])dfss(t,<span class="number">0</span>,-inf);</div><div class="line">    <span class="keyword">else</span> dfss(t,sz[fa[t]],M[fa[t]]);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">query</span><span class="params">(<span class="keyword">int</span> a,<span class="keyword">int</span> b,<span class="keyword">int</span>&amp;s,<span class="keyword">int</span>&amp;m)</span></span>&#123;</div><div class="line">    s=<span class="number">0</span>;m=-inf;</div><div class="line">    <span class="keyword">while</span>(a!=b)&#123;</div><div class="line">        <span class="keyword">if</span>(deep[a]&lt;deep[b])swap(a,b);</div><div class="line">        <span class="keyword">if</span>(belong[a]==belong[b])</div><div class="line">            s+=w[a],m=max(m,w[a]),a=fa[a];</div><div class="line">        <span class="keyword">else</span>&#123;</div><div class="line">            <span class="keyword">if</span>(deep[belong[a]]&lt;deep[belong[b]])swap(a,b);</div><div class="line">            s+=sz[a],m=max(m,M[a]),a=fa[belong[a]];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    m=max(m,w[a]);s+=w[a];</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">int</span> &amp;res)</span></span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">char</span> ch;<span class="keyword">int</span> flag=<span class="number">1</span>;</div><div class="line">    <span class="keyword">while</span>((ch=getchar())&lt;<span class="string">'0'</span>||ch&gt;<span class="string">'9'</span>)<span class="keyword">if</span>(ch==<span class="string">'-'</span>)flag=<span class="number">-1</span>;res=ch<span class="number">-48</span>;</div><div class="line">    <span class="keyword">while</span>((ch=getchar())&gt;=<span class="string">'0'</span>&amp;&amp;ch&lt;=<span class="string">'9'</span>)res=res*<span class="number">10</span>+ch<span class="number">-48</span>;res*=flag;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</div><div class="line">    read(n),sqrtn=<span class="built_in">sqrt</span>(n)+<span class="number">1</span>;</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">register</span> <span class="keyword">int</span> i=<span class="number">0</span>;i&lt;n<span class="number">-1</span>;i++)read(s),read(t),--s,--t,addedge(s,t),addedge(t,s);</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">register</span> <span class="keyword">int</span> i=<span class="number">0</span>;i&lt;n;i++)read(w[i]),belong[i]=i;</div><div class="line">    dfsf(<span class="number">0</span>,<span class="number">-1</span>,<span class="number">0</span>),read(q);</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">register</span> <span class="keyword">int</span> i=<span class="number">0</span>;i&lt;n;i++)<span class="keyword">if</span>(belong[i]==i)dfss(i,<span class="number">0</span>,-inf);</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">register</span> <span class="keyword">int</span> i=<span class="number">0</span>;i&lt;q;i++)&#123;</div><div class="line">        <span class="built_in">scanf</span>(<span class="string">"%s"</span>,cmd);</div><div class="line">        read(s),read(t);</div><div class="line">        <span class="keyword">if</span>(cmd[<span class="number">0</span>]==<span class="string">'C'</span>)change(s<span class="number">-1</span>,t);</div><div class="line">        <span class="keyword">else</span>&#123;</div><div class="line">            query(s<span class="number">-1</span>,t<span class="number">-1</span>,x,y);</div><div class="line">            <span class="keyword">if</span>(cmd[<span class="number">1</span>]==<span class="string">'S'</span>)<span class="built_in">printf</span>(<span class="string">"%d\n"</span>,x);</div><div class="line">            <span class="keyword">else</span> <span class="built_in">printf</span>(<span class="string">"%d\n"</span>,y);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>直观感受就是简洁暴力，效率也是极其高的，是链剖的级别。但是时间复杂度理论却为\( O(n\sqrt n) \)只能说明常数竟然为链剖级别！！<br>块状树的理论在这里 <a href="http://wjmzbmr.com/archives/massive_tree/" target="_blank" rel="external">WJMZBMR（%%%）</a><br>就像论文里描述的，块状树目前只能解决单点、链的问题，针对子树问题就比较尴尬了。</p>
<h4 id="博主不自量力，正在研究块状树对子树问题的解决方法。（多半是借助其他数据结构。。。）"><a href="#博主不自量力，正在研究块状树对子树问题的解决方法。（多半是借助其他数据结构。。。）" class="headerlink" title="博主不自量力，正在研究块状树对子树问题的解决方法。（多半是借助其他数据结构。。。）"></a>博主不自量力，正在研究块状树对子树问题的解决方法。（多半是借助其他数据结构。。。）</h4><p>建块的方法：Dfs一下，对每个结点只要其属于的块大小不超过SqrtN，就把其孩子加入其属于的块，否则其孩子自立一个块——from clj<br>这种建块方法严格保证块直径，大小，连通性，不保证块个数,<br>但是这种类似于SIZE的树上分块方法实际上效果很不错。</p>
<p>鉴于块状树的开发是否会有更大的进展目前暂时不明了，所以这里就此打住。在竞赛中，块状树在暴力的应用应该更显著，毕竟\( \sqrt n \)的复杂度也确实比较大；</p>
<h2 id="过渡Ⅱ"><a href="#过渡Ⅱ" class="headerlink" title="过渡Ⅱ"></a>过渡Ⅱ</h2><p>从块状树上面我们最应该学到的是其树上分块的思想，树上分块与树上分治是解决树上问题的利器。如何树上分块是依据题目特点<br>、要求所决定的。<br>所以下一章节便是<br>——</p>
<h1 id="树上分块"><a href="#树上分块" class="headerlink" title="树上分块"></a>树上分块</h1><p>大致上分为4类：</p>
<h3 id="DFS序分块"><a href="#DFS序分块" class="headerlink" title="DFS序分块"></a>DFS序分块</h3><p>通过DFS序每\( \sqrt N \)个点分成一块，好写，非常有利于与<br>DFS 序有关的题目，且严格保证了块的大小，不保证块直径。</p>
<h3 id="HEIGHT分块"><a href="#HEIGHT分块" class="headerlink" title="HEIGHT分块"></a>HEIGHT分块</h3><p>通过Depth每\( \sqrt {Hmax} \)分成一块，好写，严格保证块直径，<br>不保证块大小，保证连通。</p>
<h3 id="SIZE分块"><a href="#SIZE分块" class="headerlink" title="SIZE分块"></a>SIZE分块</h3><p>检验父亲所在的size是否小于\( \sqrt N \)，小于就加入，否则新开<br>一块，严格保证块直径，大小，连通性，不保证块个数。</p>
<h3 id="王室联邦分块"><a href="#王室联邦分块" class="headerlink" title="王室联邦分块"></a>王室联邦分块</h3><p>保证块直径，大小，个数，不保证联通。</p>
<p>##归纳<br>上述4种方法各有优劣，一般说来DFS序、SIZE分块法比较常见，而王室联邦的分块方法则更像真正的高级树上分块方法，详情见下文。至于HEIGHT分块法。。。。我连例题都找不到一道，囧，知道有这样一种概念就好了吧。</p>
<h4 id="BZOJ1086王室联邦"><a href="#BZOJ1086王室联邦" class="headerlink" title="BZOJ1086王室联邦"></a><a href="http://www.lydsy.com/JudgeOnline/problem.php?id=1086" target="_blank" rel="external">BZOJ1086王室联邦</a></h4><p>很有趣的题，鉴于普通的树上分块可以被菊花图开卡掉，所以我们可以考虑为其他的块预留一些位置，考虑到当一块size&gt;=b时，就把这些分成一块。深度搜索时仍然是从任意节点开始，维护一个栈，当节点退出递归时便压栈，自上而下的合并至块中。所以当某子树深搜完后栈内元素&gt;=b时便合并成一块。所以其缺点中的不保证联通性就是如果某子树深搜后栈内元素不够b，那么这些元素就会与下一个子树内部的节点合并，直至元素个数&gt;=b。<br>所以我们每一次递归时维护栈底，对于当前子树，这个栈底即是整个栈的底，栈底下元素不可被修改、弹栈。最后保证了子树内未分分块的节点数&lt;=b,并且每块的大小也不超过2b，将剩余节点暴力塞进最后一块中，那么最大的块就不会超过3b的size的大小。</p>
<h3 id="重点：-DFS序与SIZE"><a href="#重点：-DFS序与SIZE" class="headerlink" title="重点： DFS序与SIZE"></a>重点： DFS序与SIZE</h3><p>尽管有种种什么菊花图、链式图来卡树上分块，（那毕竟是少数无良出题人。。。。。），DFS序分块作为树问题转序列问题的经典方法，是很值得OIer学习的，考虑到维护时间戳，记录节点入度与出度的时间，可以轻松将树压缩与序列之上，剩下的什么分块就可以完美胜任了。</p>
<h4 id="DFS序的运用"><a href="#DFS序的运用" class="headerlink" title="DFS序的运用"></a>DFS序的运用</h4><blockquote>
<p>给定一颗树, 和每个节点的权值.下面有7个经典的关于dfs序的问题:</p>
<ol>
<li><p>对某个节点X权值加上一个数W, 查询某个子树X里所有点权的和.<br>由于X的子树在DFS序中是连续的一段, 只需要维护一个dfs序列,用树状数组实现:单点修改和区间查询.</p>
</li>
<li><p>对节点X到Y的最短路上所有点权都加一个数W, 查询某个点的权值.<br>这个操作等价于<br>a. 对X到根节点路径上所有点权加W<br>b. 对Y到根节点路径上所有点权加W<br>c. 对LCA(x, y)到根节点路径上所有点权值减W<br>d. 对LCA(x,y)的父节点 fa(LCA(x, y))到根节点路径上所有权值减W<br>于是要进行四次这样从一个点到根节点的区间修改.将问题进一步简化, 进行一个点X到根节点的区间修改, 查询其他一点Y时,只有X在Y的子树内, X对Y的值才有贡献且贡献值为W.当单点更新X时,X实现了对X到根的路径上所有点贡献了W.于是只需要更新四个点(单点更新) ,查询一个点的子树内所有点权的和(区间求和)即可.</p>
</li>
<li><p>对节点X到Y的最短路上所有点权都加一个数W, 查询某个点子树的权值之和.<br>同问题2中的修改方法, 转化为修改某点到根节点的权值加/减W<br>当修改某个节点A, 查询另一节点B时<br>只有A在B的子树内, Y的值会增加<br>W <em> (dep[A] - dep[B] + 1) =&gt; W </em> (dep [A] + 1) - W <em> dep[B]<br>那么我们处理两个数组就可以实现:<br>处理出数组Sum1,每次更新W</em>(dep[A]+1),和数组Sum2,每次更新W.<br>每次查询结果为Sum1(R[B]) – Sum1(L[B]-1) - (Sum2(R[B]) – Sum2(L[B]-1)) * dep [B].</p>
</li>
<li><p>对某个点X权值加上一个数W, 查询X到Y路径上所有点权之和.<br>求X到Y路径上所有的点权之和, 和前面X到Y路径上所有点权加一个数相似<br>这个问题转化为<br>X到根节点的和 + Y到根节点的和 - LCA(x, y)到根节点的和 - fa(LCA(x,y)) 到根节点的和<br>更新某个点x的权值时,只会对它的子树产生影响,对x的子树的每个点到根的距离都加了W.<br>那么我们用”刷漆”(差分前缀和),更新一个子树的权值.给L[x]加上W,给R[x]+1减去W,那么sum(1~L[k])就是k到根的路径点权和.</p>
</li>
<li><p>对节点X的子树所有节点加上一个值W, 查询X到Y的路径上所有点的权值和<br>同问题4把路径上求和转化为四个点到根节点的和<br>X到根节点的和 + Y到根节点的和 - LCA(x, y)到根节点的和 - parent(LCA(x,y)) 到根节点的<br>再用刷漆只更新子树.<br>修改一点A, 查询某点B到根节点时, 只有B在A的子树内, A对B才有贡献.<br>贡献为W <em> (dep[B] - dep[A] + 1) =&gt; W </em> (1 - dep[A]) + W <em> dep[B]<br>和第三题一样, 用两个sum1,sum2维护 W </em>(dep[A] + 1),和W.<br>最后答案就是sum2*dep[B]-sum1.</p>
</li>
<li>对子树X里所有节点加上一个值W, 查询某个点的值.<br>对DFS序来说, 子树内所有节点加W, 就是一段区间加W.<br>所以这个问题就是 区间修改, 单点查询.树状数组+刷漆.</li>
<li>对子树X里所有节点加上一个值W, 查询某个子树的权值和.<br>子树所有节点加W, 就是某段区间加W, 查询某个子树的权值和, 就是查询某段区间的和<br>区间修改区间求和,用线段树可以很好解决。</li>
</ol>
</blockquote>
<p>以上引用自<a href="http://blog.csdn.net/lin452/article/details/51771456" target="_blank" rel="external">here</a><br>上面总结得十分详细，不可谓不全。<br>可以看出dfs序在树上操作中发挥了至关重要的作用，配合上线段树等其他数据结构，可以在基础树上操作内问题上纵横了。<br>但是dfs序最关键的是其思想：</p>
<h5 id="树型转序列！"><a href="#树型转序列！" class="headerlink" title="树型转序列！"></a>树型转序列！</h5><p>无论是线段树还是树状数组（两种烂大街但又无可替代的基础数据结构）都是序列型数据结构，能够转化为序列无疑是解决问题的一种方式。<br>回想树链剖分，不也是通过dfs将其编号然后植入到其他数据结构中解决吗？</p>
<h4 id="size分块"><a href="#size分块" class="headerlink" title="size分块"></a>size分块</h4><p>这种分块方式就更加贴近于本身的树上分块的特点（在树上？）:作用于树上。<br>举个例：<a href="http://www.lydsy.com/JudgeOnline/problem.php?id=3731" target="_blank" rel="external">Gty的妹子树（注意：没有“超级”）</a><br>这道题就是典型的size分块的题：<br>如果用王室联邦分块的话需要维护每一个块dfs的序最小值和最大值，并且插入操作会破坏原来的性质，所以很GG，不如直接按sizes分块，根节点size&lt; block就加入根，否则新建块。<br>因为size分块不能保证块的数量，可以被菊花图卡掉，但是本题并没有所以就可以安心的写size，然后每个块维护排序后的值。<br>对于查询操作，不完整的块(因为是size分块所以只有子树根所在块不完整)暴力，直接把块重建一个图，每个块都整体二分。<br>修改维护有序，插入也维护有序,当然修改和插入后重新排序也可以.<br>复杂度 修改插入\( O(S) \) 查询\( O(S+\frac{N}{S}log_S) \)</p>
<h4 id="HEIGHT分块-1"><a href="#HEIGHT分块-1" class="headerlink" title="HEIGHT分块"></a>HEIGHT分块</h4><p>我只能说无可奉告。。。。</p>
<h2 id="过渡Ⅲ"><a href="#过渡Ⅲ" class="headerlink" title="过渡Ⅲ"></a>过渡Ⅲ</h2><p>那么下一章的方向也就很明显了，既然树分块都讲了，那么树分治肯定跑不了了，树的分块给人的感觉就是直接，在块内暴力，块上打标记，具体这么做有什么卵用。。。<br>花一点点篇幅谈谈吧，鉴于log级别的操作是极其强势的，所以思考分块比树类数据结构强在where？\( O(1) \)查询历史，详细方式见<a href="http://www.lydsy.com/JudgeOnline/problem.php?id=2589" target="_blank" rel="external">BZOJ2589</a>与<a href="http://www.lydsy.com/JudgeOnline/problem.php?id=4763" target="_blank" rel="external">BZOJ4763</a></p>
<p>然后言归正传，边分治、点分治，我来了！！！</p>
<h1 id="树分治"><a href="#树分治" class="headerlink" title="树分治"></a>树分治</h1>

    
    
    

  </section>
</article>
  
    <article class="post no-title">

  
  <time>
    Sep 25, 2017
  </time>
  <section class="content">
	  <p><a href="http://debug18.com/posts/calculate-the-sum-of-multiplicative-function/" target="_blank" rel="external">blog源地址</a><br>感谢__debug大佬。</p>
<h1 id="洲阁筛"><a href="#洲阁筛" class="headerlink" title="洲阁筛"></a>洲阁筛</h1><p>一种在 \( O(\frac{n^{\frac{3}{4}}}{\log n})\) 的时间中求出大多数积性函数的前缀和的方法.</p>
<p>引入<br>求 \( \sum_{i = 1}^{n} F(i) \)<br>其中 \( F(x) \) 是一个积性函数. 要求在低于线性的时间内求出.</p>
<p>转化<br>如果 \( F(x) \) 是一个十分特殊的积性函数, 比如 \( \mu^2(x) \), 那么可以非常快地求出; 就算它不那么特殊, 如果我们能找到两个合适的函数 \( G, H \) 满足\( F * G = H \), 并且\( G, H \) 的前缀和容易求出, 那么可以利用杜教筛在 \( O(n^{\frac{2}{3}}) \)的时间内求出. 但是当\( F(x)\) 不具备这些性质的时候呢?</p>
<p>当然了, 还是有一个要求: 当 \( p\) 为质数的时候, \( F(p^c) \) 是一个关于 (p) 的低阶多项式.</p>
<p>我们将 \( [1, n]\)的所有数按照是否有 \( &gt; \sqrt{n}\) 的质因子分为两类, 那么显然有: \( \sum<em>{i = 1}^{n} F(i) = \sum</em>{\substack{1 \le i \le n \ i \text{ have no prime factors } &gt; \sqrt{n} }} F(i) \left( 1 + \sum_{\substack{\sqrt{n} &lt; j \le \lfloor \frac{n}{i} \rfloor \ j \text{ is prime}}} F(j) \right) \)</p>
<p>由于 \( i \ge \sqrt{n}\) 时后面一部分等于 \(1\), 所以需要计算以下两个东西:</p>
<p>对于每个 \(1 \le i &lt; \sqrt{n}\), 计算 \( \sum<em>{\substack{\sqrt{n} &lt; j \le \lfloor \frac{n}{i} \rfloor \ j \text{ is prime}}}  F(j)  \sum</em>{\substack{\sqrt{n} \le i \le n \ i \text{ have no prime factors } &gt; \sqrt{n} }} F(i) \)<br>当然, 最后还要用线性筛求出 \([1, \sqrt{n})\)的 \(F(x)\) 乘上相应的系数对答案的贡献, 这一部显然不会成为瓶颈.</p>
<h1 id="Part-1"><a href="#Part-1" class="headerlink" title="Part 1"></a>Part 1</h1><p>设 \(g_k(i, j)\) 表示 \([1, j]\) 中与前 \(i\) 个质数互质的数的 \(k\) 次幂和. 显然有转移 \(g_k(i, j) = g_k(i - 1, j) - p_i^k g_k(i - 1, \lfloor \frac{j}{p_i} \rfloor) \)</p>
<p>观察到 \(j\) 的取值只有 \(\sqrt{n}\) 种, 于是直接暴力计算的复杂度为 \(O(\frac{n}{\log n})\).</p>
<p>考虑优化. 首先注意到当 \(p_{i + 1} &gt; j\) 时 \(g_k(i, j) = 1\), 但是这个观察并不能带来什么优化; 紧接着我们发现如果 \(p_i &gt; \lfloor \frac{j}{p_i} \rfloor\) 即 \(p_i^2 &gt; j\) 时, \(g_k(i, j)\) 的转移变为: \(g_k(i, j) = g_k(i - 1, j) - p_i^k\)</p>
<p>我们从小到大枚举 \(i\), 对于某个 \(j\) 一旦 \(p_{i_0}^2 &gt; j\) 便可以不再转移, 之后如果其他的值需要使用到它在 \(i_1\) 时的值, 直接用 \(g_k(i<em>0, j) - \sum</em>{l = i_0}^{i_1 - 1} p_l^k\) 即可. (其实这个地方还有一些细节, 可以自己思考)</p>
<p>此时的复杂度可以简单地用积分近似为 \(O(\frac{n\frac{3}{4}}{\log n})\).</p>
<h1 id="Part-2"><a href="#Part-2" class="headerlink" title="Part 2"></a>Part 2</h1><p>设 \(f(i, j)\) 表示 \([1, j]\) 中仅由前 \(i\) 个质数组成的数的 \(F(x)\) 之和. 显然有转移 \(f(i, j) = f(i - 1, j) + \sum_{c \ge 1} F(p_i^c) f(i - 1, \lfloor \frac{j}{p_i^c} \rfloor)\)</p>
<p>虽然多出来一个 \(\sum_{c \ge 1}\), 但是直接暴力计算的复杂度仍然是 \(O(\frac{n}{\log n})\). 如何优化? 似乎不太能沿用之前的方法了.</p>
<p>但是如果将状态定义中的”前 \(i\) 个质数”改为”(小于 \( \sqrt{n}\)的后 \(i\) 个质数”, 此时当 \(p_i &gt; j\) 时, 一定有 \(f(i, j) = 1\). 类似地, 当 \(p_i^2 &gt; j\) 时转移变为: \(f(i, j) = f(i - 1, j) + F(p_i) \)</p>
<p>所以可以从大到小枚举 \(i\), 如果对于某个 \(j\) 有 \(p_i^2 &gt; j\), 可以不转移, 每次用的时候加入 \([p_i, \min(j, \sqrt{n})]\) 这一段的质数的 \(F(p)\) 就可以了.</p>
<p>类似上面的分析, 复杂度为 \(O(\frac{n^{\frac{3}{4}}}{\log n})\).</p>
<p>小结<br>从上面的推导可以看出, 如果 \(F(p^c)\) 是一个关于 \(p\) 的常数阶多项式, 那么我们可以在 \(O(\frac{n^{\frac{3}{4}}}{\log n})\) 的时间内求出 \(F(x)\) 的前 \(n\) 项和. 利用滚动数组, 空间复杂度是 \(O(\sqrt{n})\) 的.</p>
<p>主要用到了以下几个想法:</p>
<p>将所有数分按照有无大于 \(\sqrt{n}\) 的质因子为两类<br>整除的结果只有 \(O(\sqrt{n})\) 种<br>一个关于递推的优化技巧<br>这几个想法相对独立, 都挺有启发性的, 感觉甚至可以优化一些 DP.</p>
<p>例题: SPOJ DIVCNT3<br>Description<br>求 \( \sum_{i = 1}^{n} d(i^3)\)</p>
<p>其中 \(d(x)\) 表示 \(x\) 的约数个数.</p>
<p> \( n \le 10^{11} \) , 时限 20s.</p>
<p>Solution<br>直接上洲阁筛, 其中 \(F(p^c) = 3c + 1\).</p>
<p>提供主要代码以供参考. 其中 \(sump[i]\) 表示小于等于 \(i\) 的质数之和, \(d3[i]\) 表示 \(d(i^3)\).<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line">LL N;</div><div class="line"><span class="keyword">int</span> pbnd;</div><div class="line"><span class="keyword">int</span> vbnd;</div><div class="line"><span class="keyword">int</span> l0[SIZE], l[SIZE];</div><div class="line">LL g0[SIZE], g[SIZE], f0[SIZE], f[SIZE];</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">calcG</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; vbnd; ++i) &#123;</div><div class="line">	g0[i] = i;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = vbnd - <span class="number">1</span>; i &gt;= <span class="number">1</span>; --i) &#123;</div><div class="line">	g[i] = N / i;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; pbnd; ++i) &#123;</div><div class="line">	<span class="keyword">int</span> p = primes[i];</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt; vbnd &amp;&amp; i &lt; l[j]; ++j) &#123;</div><div class="line">	    LL y = (N / j) / p;</div><div class="line">	    g[j] -= (y &lt; vbnd ? g0[y] - <span class="built_in">std</span>::max(<span class="number">0</span>, i - l0[y]) : g[N / y] - <span class="built_in">std</span>::max(<span class="number">0</span>, i - l[N / y]));</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> j = vbnd - <span class="number">1</span>; j &gt;= <span class="number">1</span> &amp;&amp; i &lt; l0[j]; --j) &#123;</div><div class="line">	    LL y = j / p;</div><div class="line">	    g0[j] -= g0[y] - <span class="built_in">std</span>::max(<span class="number">0</span>, i - l0[y]);</div><div class="line">	&#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; vbnd; ++i) &#123;</div><div class="line">	g[i] -= pbnd - l[i];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">calcF</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="built_in">std</span>::fill(f0 + <span class="number">1</span>, f0 + vbnd, <span class="number">1</span>);</div><div class="line">    <span class="built_in">std</span>::fill(f + <span class="number">1</span>, f + vbnd, <span class="number">1</span>);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = pbnd - <span class="number">1</span>; i &gt;= <span class="number">0</span>; --i) &#123;</div><div class="line">	<span class="keyword">int</span> p = primes[i];</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">1</span>; j &lt; vbnd &amp;&amp; i &lt; l[j]; ++j) &#123;</div><div class="line">	    LL y = (N / j) / p;</div><div class="line">	    <span class="keyword">for</span> (<span class="keyword">int</span> z = <span class="number">1</span>; y; ++z, y /= p) &#123;</div><div class="line">		f[j] += (<span class="number">3</span> * z + <span class="number">1</span>) * (y &lt; vbnd ?</div><div class="line">				       f0[y] + <span class="number">4</span> * <span class="built_in">std</span>::max(<span class="number">0</span>, sump[y] - <span class="built_in">std</span>::max(l0[y], i + <span class="number">1</span>)) :</div><div class="line">				       f[N / y] + <span class="number">4</span> * (pbnd - <span class="built_in">std</span>::max(l[N / y], i + <span class="number">1</span>)));</div><div class="line">	    &#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> j = vbnd - <span class="number">1</span>; j &gt;= <span class="number">1</span> &amp;&amp; i &lt; l0[j]; --j) &#123;</div><div class="line">	    <span class="keyword">int</span> y = j / p;</div><div class="line">	    <span class="keyword">for</span> (<span class="keyword">int</span> z = <span class="number">1</span>; y; ++z, y /= p) &#123;</div><div class="line">		f0[j] += (<span class="number">3</span> * z + <span class="number">1</span>) * (f0[y] + <span class="number">4</span> * <span class="built_in">std</span>::max(<span class="number">0</span>, sump[y] - <span class="built_in">std</span>::max(l0[y], i + <span class="number">1</span>)));</div><div class="line">	    &#125;</div><div class="line">	&#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; vbnd; ++i) &#123;</div><div class="line">	f[i] += <span class="number">4</span> * (pbnd - l[i]);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function">LL <span class="title">calcSumS3</span><span class="params">()</span></span></div><div class="line"><span class="function"></span>&#123;</div><div class="line">    <span class="keyword">for</span> (vbnd = <span class="number">1</span>; (LL)vbnd * vbnd &lt;= N; ++vbnd) &#123; &#125;</div><div class="line">    <span class="keyword">for</span> (pbnd = <span class="number">0</span>; (LL)primes[pbnd] * primes[pbnd] &lt;= N; ++pbnd) &#123; &#125;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; vbnd; ++i) &#123;</div><div class="line">	<span class="keyword">for</span> (l0[i] = l0[i - <span class="number">1</span>]; (LL)primes[l0[i]] * primes[l0[i]] &lt;= i; ++l0[i]) &#123; &#125;</div><div class="line">    &#125;</div><div class="line">    l[vbnd] = <span class="number">0</span>;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = vbnd - <span class="number">1</span>; i &gt;= <span class="number">1</span>; --i) &#123;</div><div class="line">	LL x = N / i;</div><div class="line">	<span class="keyword">for</span> (l[i] = l[i + <span class="number">1</span>]; (LL)primes[l[i]] * primes[l[i]] &lt;= x; ++l[i]) &#123; &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    calcG();</div><div class="line">    calcF();</div><div class="line"></div><div class="line">    LL ret = f[<span class="number">1</span>];</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; vbnd; ++i) &#123;</div><div class="line">	ret += d3[i] * <span class="number">4</span> * (g[i] - <span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> ret;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>


    
    
    

  </section>
</article>
  
    <article class="post no-title">

  
  <time>
    Sep 25, 2017
  </time>
  <section class="content">
	  <p>重新开坑</p>
<p><iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="330" height="86" src="//music.163.com/outchain/player?type=3&id=907727144&auto=1&height=66"></iframe><br>奉上最近觉得的神作（至少从小说与这首曲子来说是这样的）。</p>
<p>之前写到过<strong>可持久化并查集三部曲</strong>，现在想来，唯独没有提到按秩合并，在研习了启发式合并后，决定重新为并查集写一份外传，记录并查集的另一作用。</p>
<p>什么是按秩合并，就小编来看，其实就是启发式合并的一种，在满足不路径压缩改变fa[x]的前提下，能够使得并查集的深度为$log^n$级别的。</p>
<p>但是提醒，这里的按秩合并与路径压缩并不矛盾，按秩合并关键在union函数，而路径压缩是在find函数中，若只是普通并查集，就只需要上路径压缩就可以了，应该没有哪个丧尽天良的出题人为了卡路径压缩要求两个优化都用才能AC。。。。</p>
<p>如何实现，先上代码。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> fa[N],f[N];</div><div class="line"><span class="keyword">int</span> siz[N],dpn[N];  </div><div class="line"><span class="keyword">int</span> cnt_merge = <span class="number">0</span>;  </div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">find</span><span class="params">(<span class="keyword">int</span> x)</span></span>&#123;  </div><div class="line">    <span class="keyword">if</span>(fa[x]==x)<span class="keyword">return</span> x;  </div><div class="line">    <span class="keyword">int</span> k=findfather(fa[x]);  </div><div class="line">    dpn[x]=dpn[fa[x]]+<span class="number">1</span>;<span class="comment">//合并时以类似求前缀的方式维护dfn中的值。  </span></div><div class="line">    <span class="keyword">return</span> k;  </div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">merge</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> y)</span></span>&#123;  <span class="comment">//uniona函数，按秩合并 </span></div><div class="line">    x=find(x),y=find(y);</div><div class="line">    <span class="keyword">if</span>(x==y)<span class="keyword">return</span> <span class="keyword">void</span>(++cnt_merge);  </div><div class="line">    <span class="keyword">if</span>(siz[x]&gt;siz[y])fa[y]=x,f[y]=++cnt_merge,siz[x]+= siz[y];  </div><div class="line">    <span class="keyword">else</span> fth[x]=y,f[x]=++cnt_merge,siz[y]+=siz[x];  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样写有什么用呢，或者说为什么这么写？<br>在两个不同子集连接时，如果我们按照rank来连接，把rank低的连在rank高的下面，让rank高的做father，那么我们就相当于维护了一棵树，保证了类似于启发式合并一样的树高最坏$log^n$。</p>
<p>神奇吧，来一道题清爽一下。</p>
<p><a href="http://www.lydsy.com/JudgeOnline/problem.php?id=4668" target="_blank" rel="external">BZOJ4668传送门</a></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//by anantheparty</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstdio&gt;</span></span></div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> N=<span class="number">5e5</span>+<span class="number">5</span>;</div><div class="line"><span class="keyword">int</span> f[N],d[N],r[N],p[N];</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">find</span><span class="params">(<span class="keyword">int</span> i)</span></span>&#123;</div><div class="line">    <span class="keyword">if</span>(p[i]==i)<span class="keyword">return</span> i;</div><div class="line">    <span class="keyword">register</span> <span class="keyword">int</span> j=find(p[i]);</div><div class="line">    d[i]=d[p[i]]+<span class="number">1</span>;</div><div class="line">    <span class="keyword">return</span> j;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">unionn</span><span class="params">(<span class="keyword">int</span> i,<span class="keyword">int</span> j)</span></span>&#123;</div><div class="line">    i=find(i),j=find(j);</div><div class="line">    <span class="keyword">if</span>(i==j)<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    <span class="keyword">if</span>(r[i]==r[j])++r[j];</div><div class="line">    <span class="keyword">if</span>(r[i]&lt;r[j])&#123;</div><div class="line">        p[i]=j;</div><div class="line">        <span class="keyword">return</span> i;</div><div class="line">    &#125;</div><div class="line">    p[j]=i;</div><div class="line">    <span class="keyword">return</span> j;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">query</span><span class="params">(<span class="keyword">int</span> i,<span class="keyword">int</span> j)</span></span>&#123;</div><div class="line">    <span class="keyword">register</span> <span class="keyword">int</span> s=<span class="number">0</span>;</div><div class="line">    <span class="keyword">if</span>(find(i)==find(j))</div><div class="line">        <span class="keyword">while</span>(i!=j)</div><div class="line">            <span class="keyword">if</span>(d[i]&gt;d[j])s&lt;f[i]?s=f[i]:<span class="number">0</span>,i=p[i];</div><div class="line">            <span class="keyword">else</span> s&lt;f[j]?s=f[j]:<span class="number">0</span>,j=p[j];</div><div class="line">    <span class="keyword">return</span> s;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">int</span> &amp;res)</span></span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">char</span> ch;</div><div class="line">    <span class="keyword">while</span>((ch=getchar())&lt;<span class="string">'0'</span>||ch&gt;<span class="string">'9'</span>);res=ch<span class="number">-48</span>;</div><div class="line">    <span class="keyword">while</span>((ch=getchar())&gt;=<span class="string">'0'</span>&amp;&amp;ch&lt;=<span class="string">'9'</span>)res=res*<span class="number">10</span>+ch<span class="number">-48</span>;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</div><div class="line">    <span class="keyword">register</span> <span class="keyword">int</span> n,m,k,s,t,last=<span class="number">0</span>;</div><div class="line">    read(n),read(m);</div><div class="line">    <span class="keyword">for</span>(;n;--n)p[n]=n;</div><div class="line">    <span class="keyword">while</span>(m--)&#123;</div><div class="line">        read(k),read(s),read(t);</div><div class="line">        s^=last,t^=last;</div><div class="line">        <span class="keyword">if</span>(k)<span class="built_in">printf</span>(<span class="string">"%d\n"</span>,last=query(s,t));</div><div class="line">        <span class="keyword">else</span> f[unionn(s,t)]=++n;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>哈哈我可没有忘记并查集系列的看板娘</p>
<p><img src="http://img.blog.csdn.net/20170709204833667?watermark/2/text/aHR0cDovL2Jsb2cuY3Nkbi5uZXQvbGVtb25vaWw=/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70/gravity/SouthEast" alt="这里写图片描述"></p>


    
    
    

  </section>
</article>
  
    <article class="post no-title">

  
  <time>
    Sep 25, 2017
  </time>
  <section class="content">
	  <p><a href="https://cn.vjudge.net/problem/SPOJ-QTREE7" target="_blank" rel="external">题目传送门</a></p>
<p>为什么突出了SET呢？因为用了set后就可以用端点写法$O(1)$维护路径。。。。然后花费$log^n$的时间插入删除。。。。。<br>还是感觉时间复杂度很GG啊，一大<strong>堆</strong>大神拿着LCT就开刷。。。不行了，我要刷QTree的二周目了，就叫拿着LCT拯救世界。</p>
<p>这道题相比Qtree6没什么区别，就查找一个max，用Qtree的线段树写法就行了，剩下的用Qtree6的思路就AC了。<br>一个l打成了r，GG好久。<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;set&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;deque&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstdio&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstring&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;algorithm&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">100100</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> mid ((l+r)&gt;&gt;1)</span></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">data</span>&#123;</span></div><div class="line">	<span class="keyword">int</span> next,to;</div><div class="line">&#125;E[N&lt;&lt;<span class="number">2</span>];</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span>&#123;</span></div><div class="line">	<span class="keyword">int</span> l,r,lc,rc;</div><div class="line">	node()&#123;&#125;</div><div class="line">	node(<span class="keyword">int</span> l,<span class="keyword">int</span> r,<span class="keyword">int</span> lc,<span class="keyword">int</span> rc):l(l),r(r),lc(lc),rc(rc)&#123;&#125;</div><div class="line">&#125;tree[N&lt;&lt;<span class="number">2</span>];</div><div class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">dis_set</span>&#123;</span></div><div class="line">	<span class="function"><span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">operator</span> <span class="params">()</span> <span class="params">(<span class="keyword">const</span> T &amp;l,<span class="keyword">const</span> T &amp;r)</span><span class="keyword">const</span></span>&#123;<span class="keyword">return</span> l&gt;r;&#125;</div><div class="line">&#125;;</div><div class="line"><span class="built_in">set</span>&lt;<span class="keyword">int</span>,dis_set&lt;<span class="keyword">int</span>&gt; &gt;val[N][<span class="number">2</span>];</div><div class="line"><span class="keyword">int</span> n,q,x,y,z;</div><div class="line"><span class="keyword">int</span> head[N],sz[N],top[N],dfn[N],tot,cnt,fa[N],dft[N],sum[N],son[N];</div><div class="line"><span class="keyword">int</span> ls[N&lt;&lt;<span class="number">2</span>],rs[N&lt;&lt;<span class="number">2</span>],root[N],col[N],bct,w[N];</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">addedge</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> y)</span></span>&#123;</div><div class="line">	E[++tot].to=y,E[tot].next=head[x],head[x]=tot;</div><div class="line">	E[++tot].to=x,E[tot].next=head[y],head[y]=tot;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">dfsf</span><span class="params">(<span class="keyword">int</span> u)</span></span>&#123;</div><div class="line">	sz[u]=<span class="number">1</span>;</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">register</span> <span class="keyword">int</span> v,i=head[u];i;i=E[i].next)</div><div class="line">		<span class="keyword">if</span>(v=E[i].to,v!=fa[u])&#123;</div><div class="line">			fa[v]=u,dfsf(v),sz[u]+=sz[v];</div><div class="line">			<span class="keyword">if</span>(sz[son[u]]&lt;sz[v])son[u]=v;</div><div class="line">		&#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">dfss</span><span class="params">(<span class="keyword">int</span> u,<span class="keyword">int</span> f)</span></span>&#123;</div><div class="line">	top[u]=f,dft[dfn[u]=++cnt]=u,sum[f]++;</div><div class="line">    <span class="keyword">if</span>(son[u])dfss(son[u],f);</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">register</span> <span class="keyword">int</span> v,i=head[u];i;i=E[i].next)</div><div class="line">		<span class="keyword">if</span>(v=E[i].to,v!=fa[u]&amp;&amp;v!=son[u])dfss(v,v);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">maintain</span><span class="params">(<span class="keyword">int</span> rt,<span class="keyword">int</span> x)</span></span>&#123;</div><div class="line">	<span class="keyword">int</span> hrt=w[x];</div><div class="line">	<span class="keyword">if</span>(val[x][col[x]].size())hrt=max(hrt,*val[x][col[x]].begin());</div><div class="line">	tree[rt].l=tree[rt].r=hrt;</div><div class="line">	tree[rt].lc=tree[rt].rc=<span class="number">1</span>;</div><div class="line">&#125;</div><div class="line"><span class="function">node <span class="title">merge</span><span class="params">(node &amp;x,node &amp;y,<span class="keyword">int</span> lu,<span class="keyword">int</span> ru,<span class="keyword">bool</span> b)</span></span>&#123;</div><div class="line">	node rt=node(x.l,y.r,x.lc,y.rc);</div><div class="line">	<span class="keyword">if</span>(b&amp;&amp;x.lc==lu)rt.l=max(rt.l,y.l),rt.lc+=y.lc;</div><div class="line">	<span class="keyword">if</span>(b&amp;&amp;y.rc==ru)rt.r=max(rt.r,x.r),rt.rc+=x.rc;</div><div class="line">	<span class="keyword">return</span> rt;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">build</span><span class="params">(<span class="keyword">int</span> rt,<span class="keyword">int</span> l,<span class="keyword">int</span> r)</span></span>&#123;</div><div class="line">	<span class="keyword">if</span>(l==r)&#123;</div><div class="line">		<span class="keyword">int</span> u=dft[l];</div><div class="line">		<span class="keyword">for</span>(<span class="keyword">register</span> <span class="keyword">int</span> v,i=head[u];i;i=E[i].next)</div><div class="line">		<span class="keyword">if</span>(v=E[i].to,v!=fa[u]&amp;&amp;top[u]!=top[v])&#123;</div><div class="line">			build(root[v]=++bct,dfn[v],dfn[v]+sum[v]<span class="number">-1</span>),</div><div class="line">			val[u][col[v]].insert(tree[root[v]].l);</div><div class="line">		&#125;</div><div class="line">		maintain(rt,u);</div><div class="line">	&#125;<span class="keyword">else</span>&#123;</div><div class="line">		build(ls[rt]=++bct,l,mid),build(rs[rt]=++bct,mid+<span class="number">1</span>,r);</div><div class="line">		tree[rt]=merge(tree[ls[rt]],tree[rs[rt]],mid-l+<span class="number">1</span>,r-mid,col[dft[mid]]==col[dft[mid+<span class="number">1</span>]]);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="built_in">deque</span>&lt;<span class="keyword">int</span>&gt; Q;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">findpath</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">bool</span> flag)</span></span>&#123;</div><div class="line">	Q.clear();</div><div class="line">	<span class="keyword">while</span>(x)&#123;</div><div class="line">		<span class="keyword">int</span> f=top[x];</div><div class="line">		<span class="keyword">if</span>(flag)&#123;</div><div class="line">			<span class="keyword">if</span>(dfn[f]+tree[root[f]].lc<span class="number">-1</span>&lt;dfn[x]||col[fa[f]]!=col[f]||!fa[f])&#123;</div><div class="line">				Q.push_front(x),Q.push_front(f);<span class="keyword">break</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;<span class="keyword">else</span> Q.push_front(x),Q.push_front(f);</div><div class="line">		x=fa[f];</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">int</span> rt,<span class="keyword">int</span> l,<span class="keyword">int</span> r,<span class="keyword">int</span> x,<span class="keyword">bool</span> fb)</span></span>&#123;</div><div class="line">	<span class="keyword">if</span>(l==r)&#123;</div><div class="line">		<span class="keyword">int</span> f=dft[l];</div><div class="line">		<span class="keyword">if</span>(x+<span class="number">2</span>&lt;Q.size())&#123;</div><div class="line">			<span class="keyword">int</span> t=Q[x+<span class="number">1</span>];</div><div class="line">            val[f][col[t]].erase(val[f][col[t]].find(tree[root[t]].l));</div><div class="line">            update(root[t],dfn[t],dfn[t]+sum[t]<span class="number">-1</span>,x+<span class="number">2</span>,fb);</div><div class="line">            val[f][col[t]].insert(tree[root[t]].l);</div><div class="line">		&#125;<span class="keyword">else</span> <span class="keyword">if</span>(fb)col[f]=<span class="number">1</span>-col[f];</div><div class="line">		maintain(rt,f);</div><div class="line">	&#125;<span class="keyword">else</span>&#123;</div><div class="line">		<span class="keyword">if</span>(dfn[Q[x]]&lt;=mid)update(ls[rt],l,mid,x,fb);</div><div class="line">        <span class="keyword">else</span> update(rs[rt],mid+<span class="number">1</span>,r,x,fb);</div><div class="line">        tree[rt]=merge(tree[ls[rt]],tree[rs[rt]],mid+<span class="number">1</span>-l,r-mid,col[dft[mid]]==col[dft[mid+<span class="number">1</span>]]);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">query</span><span class="params">(<span class="keyword">int</span> rt,<span class="keyword">int</span> l,<span class="keyword">int</span> r,<span class="keyword">int</span> x,<span class="keyword">int</span> res=<span class="number">0</span>)</span></span>&#123;</div><div class="line">	<span class="keyword">if</span>(l==r)<span class="keyword">return</span> tree[rt].l;</div><div class="line">	<span class="keyword">if</span>(dfn[Q[x]]&lt;=mid)&#123;</div><div class="line">		res=query(ls[rt],l,mid,x);</div><div class="line">        <span class="keyword">if</span>(mid-tree[ls[rt]].rc+<span class="number">1</span>&lt;=dfn[Q[x]]&amp;&amp;col[dft[mid+<span class="number">1</span>]]==col[dft[mid]])</div><div class="line">			res=max(res,tree[rs[rt]].l);</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">        res=query(rs[rt],mid+<span class="number">1</span>,r,x);</div><div class="line">        <span class="keyword">if</span>(mid+tree[rs[rt]].lc&gt;=dfn[Q[x]]&amp;&amp;col[dft[mid+<span class="number">1</span>]]==col[dft[mid]])</div><div class="line">			res=max(res,tree[ls[rt]].r);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> res;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">change</span><span class="params">(<span class="keyword">int</span> u,<span class="keyword">bool</span> v)</span></span>&#123;</div><div class="line">	findpath(u,<span class="number">0</span>);</div><div class="line">	update(<span class="number">1</span>,<span class="number">1</span>,sum[<span class="number">1</span>],<span class="number">1</span>,v);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">ask</span><span class="params">(<span class="keyword">int</span> u)</span></span>&#123;</div><div class="line">	findpath(u,<span class="number">1</span>),u=Q[<span class="number">0</span>];</div><div class="line">	<span class="built_in">printf</span>(<span class="string">"%d\n"</span>,query(root[u],dfn[u],dfn[u]+sum[u]<span class="number">-1</span>,<span class="number">1</span>));</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">int</span> &amp;res)</span></span>&#123;</div><div class="line">	<span class="keyword">static</span> <span class="keyword">char</span> ch;<span class="keyword">int</span> flag=<span class="number">1</span>;</div><div class="line">	<span class="keyword">while</span>((ch=getchar())&lt;<span class="string">'0'</span>||ch&gt;<span class="string">'9'</span>)<span class="keyword">if</span>(ch==<span class="string">'-'</span>)flag=<span class="number">-1</span>;res=ch<span class="number">-48</span>;</div><div class="line">	<span class="keyword">while</span>((ch=getchar())&gt;=<span class="string">'0'</span>&amp;&amp;ch&lt;=<span class="string">'9'</span>)res=res*<span class="number">10</span>+ch<span class="number">-48</span>;res*=flag;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</div><div class="line">	read(n);</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">register</span> <span class="keyword">int</span> i=<span class="number">1</span>;i&lt;n;i++)read(x),read(y),addedge(x,y);</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">register</span> <span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=n;i++)read(col[i]);</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">register</span> <span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=n;i++)read(w[i]);</div><div class="line">	read(q),dfsf(<span class="number">1</span>),dfss(<span class="number">1</span>,<span class="number">1</span>);</div><div class="line">	build(root[<span class="number">1</span>]=++bct,<span class="number">1</span>,sum[<span class="number">1</span>]);</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">register</span> <span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=q;++i)&#123;</div><div class="line">		read(x),read(y);</div><div class="line">		<span class="keyword">if</span>(x==<span class="number">1</span>)change(y,<span class="number">1</span>);</div><div class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(x==<span class="number">2</span>)read(z),w[y]=z,change(y,<span class="number">0</span>); </div><div class="line">		<span class="keyword">else</span> ask(y);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>断断续续，历时7day，大概13个小时，QTree系列的一周目达成！！！！</p>


    
    
    

  </section>
</article>
  
    <article class="post no-title">

  
  <time>
    Sep 25, 2017
  </time>
  <section class="content">
	  <p>感觉之前拿点分治水过心里过意不去，。。。。。mdzz，我还是打了一份树链剖分的code，具体方法与QTree4相同（详见代码），维护线段树的合并时的值。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> mid ((l+r)&gt;&gt;1)</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> pf push_front</span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> N=<span class="number">1e5</span>+<span class="number">1e2</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> INF=<span class="number">0x3f3f3f3f</span>;</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span>&#123;</span></div><div class="line">	<span class="keyword">int</span> l,r;</div><div class="line">	node(<span class="keyword">int</span> l=<span class="number">0</span>,<span class="keyword">int</span> r=<span class="number">0</span>):l(l),r(r)&#123;&#125;</div><div class="line">&#125;seg[N&lt;&lt;<span class="number">2</span>];</div><div class="line"><span class="keyword">int</span> n,dfs_cnt,cnt,cs,tot,Q,xx,yy;</div><div class="line"><span class="keyword">int</span> fa[N],head[N],id[N],dfn[N],top[N],sz[N],s[N],c[N];</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">data</span>&#123;</span></div><div class="line">	<span class="keyword">int</span> to,next;</div><div class="line">&#125;E[N&lt;&lt;<span class="number">1</span>];</div><div class="line"><span class="keyword">int</span> ls[N&lt;&lt;<span class="number">2</span>],rs[N&lt;&lt;<span class="number">2</span>],root[N];</div><div class="line"><span class="built_in">deque</span>&lt;<span class="keyword">int</span>&gt; pat;</div><div class="line"><span class="built_in">multiset</span>&lt;<span class="keyword">int</span>&gt; ch[N];</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">addedge</span><span class="params">(<span class="keyword">int</span> u,<span class="keyword">int</span> v)</span></span>&#123;</div><div class="line">	E[++tot].to=v,E[tot].next=head[u],head[u]=tot;</div><div class="line">	E[++tot].to=u,E[tot].next=head[v],head[v]=tot;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">dfsf</span><span class="params">(<span class="keyword">int</span> u)</span></span>&#123;</div><div class="line">    sz[u]=<span class="number">1</span>;<span class="keyword">for</span>(<span class="keyword">register</span> <span class="keyword">int</span> v,i=head[u];i;i=E[i].next)</div><div class="line">        <span class="keyword">if</span>(v=E[i].to,v!=fa[u])fa[v]=u,dfsf(v),sz[u]+=sz[v];</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">dfss</span><span class="params">(<span class="keyword">int</span> u,<span class="keyword">int</span> f)</span></span>&#123;</div><div class="line">    dfn[id[u]=++dfs_cnt]=u;</div><div class="line">    top[u]=f,s[f]++;</div><div class="line">    <span class="keyword">register</span> <span class="keyword">int</span> mx=<span class="number">0</span>,w;</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">register</span> <span class="keyword">int</span> v,i=head[u];i;i=E[i].next)</div><div class="line">        <span class="keyword">if</span>(v=E[i].to,v!=fa[u])<span class="keyword">if</span>(mx&lt;sz[v])mx=sz[v],w=v;</div><div class="line">    <span class="keyword">if</span>(mx)dfss(w,f);</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">register</span> <span class="keyword">int</span> v,i=head[u];i;i=E[i].next)</div><div class="line">        <span class="keyword">if</span>(v=E[i].to,v!=fa[u]&amp;&amp;v!=w)dfss(v,v);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> node <span class="title">merge</span><span class="params">(node&amp; a,node&amp; b,<span class="keyword">int</span> l1,<span class="keyword">int</span> l2,<span class="keyword">int</span> l3)</span></span>&#123;</div><div class="line">    node res;</div><div class="line">    res.l=min(a.l,l1+l2+b.l);</div><div class="line">    res.r=min(b.r,l2+l3+a.r);</div><div class="line">    <span class="keyword">return</span> res;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">maintain</span><span class="params">(<span class="keyword">int</span> rt,<span class="keyword">int</span> x)</span></span>&#123;</div><div class="line">    <span class="keyword">int</span> d1=INF,d2=INF;</div><div class="line">	<span class="keyword">if</span>(c[x])d1=d2=<span class="number">0</span>;</div><div class="line">    <span class="keyword">if</span>(ch[x].size())d1=min(d1,*ch[x].begin());</div><div class="line">    <span class="keyword">if</span>(ch[x].size()&gt;<span class="number">1</span>)d2=min(d2,*(++ch[x].begin()));</div><div class="line">    seg[rt].l=seg[rt].r=d1;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">build</span><span class="params">(<span class="keyword">int</span> rt,<span class="keyword">int</span> l,<span class="keyword">int</span> r)</span></span>&#123;</div><div class="line">    <span class="keyword">if</span>(l==r)&#123;</div><div class="line">        <span class="keyword">register</span> <span class="keyword">int</span> u=dfn[l];</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">register</span> <span class="keyword">int</span> v,i=head[u];i;i=E[i].next)</div><div class="line">        	<span class="keyword">if</span>(v=E[i].to,v!=fa[u]&amp;&amp;top[v]!=top[u])</div><div class="line">        		build(root[v]=++cnt,id[v],id[v]+s[v]<span class="number">-1</span>),</div><div class="line">            	ch[u].insert(seg[root[v]].l+<span class="number">1</span>);</div><div class="line">        maintain(rt,u);</div><div class="line">	&#125;<span class="keyword">else</span>&#123;</div><div class="line">        build(ls[rt]=++cnt,l,mid);</div><div class="line">        build(rs[rt]=++cnt,mid+<span class="number">1</span>,r);</div><div class="line">        seg[rt]=merge(seg[ls[rt]],seg[rs[rt]],mid-l,<span class="number">1</span>,r-mid<span class="number">-1</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">find</span><span class="params">(<span class="keyword">int</span> u)</span></span>&#123;</div><div class="line">    pat.clear();</div><div class="line">    <span class="keyword">register</span> <span class="keyword">int</span> l=<span class="number">0</span>;</div><div class="line">    <span class="keyword">while</span>(u)&#123;</div><div class="line">        <span class="keyword">register</span> <span class="keyword">int</span> f=top[u];</div><div class="line">        pat.pf(l),pat.pf(u),pat.pf(f);</div><div class="line">        l+=id[u]-id[f]+<span class="number">1</span>,u=fa[f];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">int</span> rt,<span class="keyword">int</span> l,<span class="keyword">int</span> r,<span class="keyword">int</span> i)</span></span>&#123;</div><div class="line">    <span class="keyword">if</span>(l==r)&#123;</div><div class="line">        <span class="keyword">register</span> <span class="keyword">int</span> u=dfn[l];</div><div class="line">        <span class="keyword">if</span>(i+<span class="number">3</span>&lt;pat.size())&#123;</div><div class="line">            <span class="keyword">register</span> <span class="keyword">int</span> nd=pat[i+<span class="number">2</span>];</div><div class="line">            ch[u].erase(ch[u].find(seg[root[nd]].l+<span class="number">1</span>));</div><div class="line">            update(root[nd],id[nd],id[nd]+s[nd]<span class="number">-1</span>,i+<span class="number">3</span>);</div><div class="line">            ch[u].insert(seg[root[nd]].l+<span class="number">1</span>);</div><div class="line">        &#125;</div><div class="line">        maintain(rt,u);</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">        <span class="keyword">if</span>(id[pat[i]]&lt;=mid)update(ls[rt],l,mid,i);</div><div class="line">        <span class="keyword">else</span> update(rs[rt],mid+<span class="number">1</span>,r,i);</div><div class="line">        seg[rt]=merge(seg[ls[rt]],seg[rs[rt]],mid-l,<span class="number">1</span>,r-mid<span class="number">-1</span>);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">query</span><span class="params">(<span class="keyword">int</span> rt,<span class="keyword">int</span> l,<span class="keyword">int</span> r,<span class="keyword">int</span> i)</span></span>&#123;</div><div class="line">	<span class="keyword">int</span> res=INF;</div><div class="line">    <span class="keyword">if</span>(l==r)&#123;</div><div class="line">        <span class="keyword">if</span>(i+<span class="number">3</span>&lt;pat.size())&#123;</div><div class="line">            <span class="keyword">register</span> <span class="keyword">int</span> nd=pat[i+<span class="number">2</span>];</div><div class="line">            res=query(root[nd],id[nd],id[nd]+s[nd]<span class="number">-1</span>,i+<span class="number">3</span>);</div><div class="line">        &#125;</div><div class="line">        res=min(res,seg[rt].l+pat[i+<span class="number">1</span>]);</div><div class="line">        <span class="keyword">return</span> res;</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">        <span class="keyword">if</span>(id[pat[i]]&lt;=mid)res=min(query(ls[rt],l,mid,i),mid+<span class="number">1</span>-id[pat[i]]+seg[rs[rt]].l+pat[i+<span class="number">1</span>]);</div><div class="line">        <span class="keyword">else</span> res=min(query(rs[rt],mid+<span class="number">1</span>,r,i),seg[ls[rt]].r+id[pat[i]]-mid+pat[i+<span class="number">1</span>]);</div><div class="line">        <span class="keyword">return</span> res;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">int</span> &amp;res)</span></span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">char</span> ch;<span class="keyword">int</span> flag=<span class="number">1</span>;</div><div class="line">    <span class="keyword">while</span>((ch=getchar())&lt;<span class="string">'0'</span>||ch&gt;<span class="string">'9'</span>)<span class="keyword">if</span>(ch==<span class="string">'-'</span>)flag=<span class="number">-1</span>;res=ch<span class="number">-48</span>;</div><div class="line">    <span class="keyword">while</span>((ch=getchar())&gt;=<span class="string">'0'</span>&amp;&amp;ch&lt;=<span class="string">'9'</span>)res=res*<span class="number">10</span>+ch<span class="number">-48</span>;res*=flag;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</div><div class="line"></div><div class="line">    read(n);</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">register</span> <span class="keyword">int</span> a,b,i=<span class="number">1</span>;i&lt;n;i++)</div><div class="line">        read(a),read(b),addedge(a,b);</div><div class="line">    dfsf(<span class="number">1</span>),dfss(<span class="number">1</span>,<span class="number">1</span>);read(Q);</div><div class="line">    build(root[<span class="number">1</span>]=++cnt,<span class="number">1</span>,s[<span class="number">1</span>]);</div><div class="line">    <span class="keyword">while</span>(Q--)&#123;</div><div class="line">        read(xx),read(yy),find(yy);</div><div class="line">        <span class="keyword">if</span>(xx)&#123;</div><div class="line">            <span class="keyword">if</span>(!cs)&#123;<span class="built_in">puts</span>(<span class="string">"-1"</span>);<span class="keyword">continue</span>; &#125;</div><div class="line">            <span class="built_in">printf</span>(<span class="string">"%d\n"</span>,query(<span class="number">1</span>,<span class="number">1</span>,s[<span class="number">1</span>],<span class="number">1</span>));</div><div class="line">    	&#125;<span class="keyword">else</span>&#123;</div><div class="line">            cs+=<span class="number">1</span>-c[yy]*<span class="number">2</span>,c[yy]=<span class="number">1</span>-c[yy];</div><div class="line">            update(<span class="number">1</span>,<span class="number">1</span>,s[<span class="number">1</span>],<span class="number">1</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

    
    
    

  </section>
</article>
  
    <article class="post no-title">

  
  <time>
    Sep 25, 2017
  </time>
  <section class="content">
	  <p>点分治模板题，我有个max细节没注意到，root一直取错，小数据AC，大数据就TLE了。。。。找了半天才发现。。。<br>MD<br>点分治+堆维护路径值（与QTree4很像）。<br>code</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;algorithm&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstring&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstdio&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cmath&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;queue&gt;</span></span></div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> N=<span class="number">200220</span>;</div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">()</span></span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">char</span> ch;<span class="keyword">int</span> flag=<span class="number">1</span>,res=<span class="number">0</span>;</div><div class="line">    <span class="keyword">while</span>((ch=getchar())&lt;<span class="string">'0'</span>||ch&gt;<span class="string">'9'</span>)<span class="keyword">if</span>(ch==<span class="string">'-'</span>)flag=<span class="number">-1</span>;res=ch<span class="number">-48</span>;</div><div class="line">    <span class="keyword">while</span>((ch=getchar())&gt;=<span class="string">'0'</span>&amp;&amp;ch&lt;=<span class="string">'9'</span>)res=res*<span class="number">10</span>+ch<span class="number">-48</span>;</div><div class="line">	<span class="keyword">return</span> res*=flag;</div><div class="line">&#125;</div><div class="line"><span class="keyword">int</span> to[N],nxt[N];</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span>&#123;</span></div><div class="line">	<span class="keyword">int</span> u,dis;</div><div class="line">	<span class="keyword">bool</span> <span class="keyword">operator</span> &lt; (<span class="keyword">const</span> node &amp;rhs)<span class="keyword">const</span>&#123;</div><div class="line">		<span class="keyword">return</span> dis&gt;rhs.dis;</div><div class="line">	&#125;</div><div class="line">&#125;;</div><div class="line">priority_queue&lt;node&gt; q[N];</div><div class="line"><span class="keyword">int</span> n,tot=<span class="number">1</span>,cnt,x,y,zx,zy,t,tal,dt,root;</div><div class="line"><span class="keyword">int</span> deep[N],head[N],sz[N],mx[N],fa[N][<span class="number">20</span>],dis[N][<span class="number">20</span>],tail[N];</div><div class="line"><span class="keyword">bool</span> vis[N],col[N];</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">dfs1</span><span class="params">(<span class="keyword">int</span> u,<span class="keyword">int</span> f)</span></span>&#123;</div><div class="line">	sz[u]=<span class="number">1</span>;<span class="keyword">for</span>(<span class="keyword">int</span> i=head[u];i;i=nxt[i])</div><div class="line">		<span class="keyword">if</span>(to[i]!=f&amp;&amp;!vis[to[i]])dfs1(to[i],u),sz[u]+=sz[to[i]];</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">dfs2</span><span class="params">(<span class="keyword">int</span> u,<span class="keyword">int</span> f)</span></span>&#123;</div><div class="line">	mx[u]=tal-sz[u];<span class="keyword">for</span>(<span class="keyword">int</span> i=head[u];i;i=nxt[i])</div><div class="line">		<span class="keyword">if</span>(to[i]!=f&amp;&amp;!vis[to[i]])dfs2(to[i],u),mx[u]=max(mx[u],sz[to[i]]);</div><div class="line">	<span class="keyword">if</span>(mx[u]&lt;dt)dt=mx[u],root=u;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">dfs3</span><span class="params">(<span class="keyword">int</span> u,<span class="keyword">int</span> f,<span class="keyword">int</span> dep,<span class="keyword">int</span> d)</span></span>&#123;</div><div class="line">	fa[u][dep]=root,dis[u][dep]=d;</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=head[u];i;i=nxt[i])</div><div class="line">		<span class="keyword">if</span>(to[i]!=f&amp;&amp;!vis[to[i]])dfs3(to[i],u,dep,d+<span class="number">1</span>);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">dfs</span><span class="params">(<span class="keyword">int</span> u,<span class="keyword">int</span> dep)</span></span>&#123;</div><div class="line">	dfs1(u,<span class="number">0</span>);</div><div class="line">	tal=dt=sz[u];dfs2(u,<span class="number">0</span>);</div><div class="line">	vis[u=root]=<span class="literal">true</span>;tail[u]=dep;</div><div class="line">	dfs3(u,<span class="number">0</span>,dep,<span class="number">0</span>);</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=head[u];i;i=nxt[i])</div><div class="line">		<span class="keyword">if</span>(!vis[to[i]])dfs(to[i],dep+<span class="number">1</span>);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</div><div class="line">	n=read();</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;n;i++)&#123;</div><div class="line">		x=read();y=read();</div><div class="line">		to[++tot]=y,nxt[tot]=head[x],head[x]=tot,</div><div class="line">	    to[++tot]=x,nxt[tot]=head[y],head[y]=tot;</div><div class="line">	&#125;</div><div class="line">	dfs(<span class="number">1</span>,<span class="number">0</span>);n=read();zx=<span class="number">0</span>;</div><div class="line">	<span class="keyword">while</span>(n--)&#123;</div><div class="line">		<span class="keyword">int</span> i;</div><div class="line">		<span class="keyword">if</span>(read())&#123;</div><div class="line">			y=read();</div><div class="line">			<span class="keyword">if</span>(zx)&#123;</div><div class="line">				zy=<span class="number">1</span>&lt;&lt;<span class="number">30</span>;</div><div class="line">				<span class="keyword">for</span>(i=tail[y];i&gt;=<span class="number">0</span>;i--)&#123;</div><div class="line">					t=fa[y][i];</div><div class="line">					<span class="keyword">while</span>(!q[t].empty()&amp;&amp;!col[q[t].top().u])q[t].pop();</div><div class="line">					<span class="keyword">if</span>(!q[t].empty())zy=min(zy,q[t].top().dis+dis[y][i]);</div><div class="line">				&#125;</div><div class="line">				<span class="built_in">printf</span>(<span class="string">"%d\n"</span>,zy);</div><div class="line">			&#125;<span class="keyword">else</span> <span class="built_in">puts</span>(<span class="string">"-1"</span>);</div><div class="line">		&#125;<span class="keyword">else</span> <span class="keyword">if</span>(col[y=read()]^=<span class="number">1</span>)<span class="keyword">for</span>(i=tail[y],zx++;i&gt;=<span class="number">0</span>;i--)q[fa[y][i]].push((node)&#123;y,dis[y][i]&#125;);<span class="keyword">else</span> zx--;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

    
    
    

  </section>
</article>
  
    <article class="post no-title">

  
  <time>
    Sep 25, 2017
  </time>
  <section class="content">
	  <p>啊啊啊！！！<br>maintain的时候忘记<del>+1s</del>+1，于是就。。。累死了，只剩下最后一个Qtree7.<br>这道题与上道题类似，关键在于路径上面判定同色，关键点在findpath上，至于线段树，我又一次惊叹于线段树在序列问题上近乎无敌的维护效率。中间的mid与mid+1的判定神来之笔。<br>看来我就是一只菜鸡。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;deque&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;vector&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstdio&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstring&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;algorithm&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> N = <span class="number">100100</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> mid ((l+r)&gt;&gt;1)</span></div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">data</span>&#123;</span></div><div class="line">	<span class="keyword">int</span> next,to;</div><div class="line">&#125;E[N&lt;&lt;<span class="number">2</span>];</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span>&#123;</span></div><div class="line">	<span class="keyword">int</span> l,r,ret;</div><div class="line">	node(<span class="keyword">int</span> l=<span class="number">0</span>,<span class="keyword">int</span> r=<span class="number">0</span>,<span class="keyword">int</span> s=<span class="number">1</span>):l(l),r(r),ret(s)&#123;&#125;</div><div class="line">&#125;tree[N&lt;&lt;<span class="number">2</span>];</div><div class="line"><span class="keyword">bool</span> G,H;</div><div class="line"><span class="keyword">int</span> n,q,x,y,z;</div><div class="line"><span class="keyword">int</span> head[N],sz[N],top[N],dfn[N],tot,cnt,fa[N],dft[N],sum[N],son[N];</div><div class="line"><span class="keyword">int</span> ls[N&lt;&lt;<span class="number">2</span>],rs[N&lt;&lt;<span class="number">2</span>],root[N],val[N][<span class="number">2</span>],col[N],bct;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">addedge</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> y)</span></span>&#123;</div><div class="line">	E[++tot].to=y,E[tot].next=head[x],head[x]=tot;</div><div class="line">	E[++tot].to=x,E[tot].next=head[y],head[y]=tot;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">dfsf</span><span class="params">(<span class="keyword">int</span> u)</span></span>&#123;</div><div class="line">	sz[u]=<span class="number">1</span>;</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">register</span> <span class="keyword">int</span> v,i=head[u];i;i=E[i].next)</div><div class="line">		<span class="keyword">if</span>(v=E[i].to,v!=fa[u])&#123;</div><div class="line">			fa[v]=u,dfsf(v),sz[u]+=sz[v];</div><div class="line">			<span class="keyword">if</span>(sz[son[u]]&lt;sz[v])son[u]=v;</div><div class="line">		&#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">dfss</span><span class="params">(<span class="keyword">int</span> u,<span class="keyword">int</span> f)</span></span>&#123;</div><div class="line">	top[u]=f,dft[dfn[u]=++cnt]=u,sum[f]++;</div><div class="line">    <span class="keyword">if</span>(son[u])dfss(son[u],f);</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">register</span> <span class="keyword">int</span> v,i=head[u];i;i=E[i].next)</div><div class="line">		<span class="keyword">if</span>(v=E[i].to,v!=fa[u]&amp;&amp;v!=son[u])dfss(v,v);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">maintain</span><span class="params">(<span class="keyword">int</span> rt,<span class="keyword">int</span> x)</span></span>&#123;</div><div class="line">	tree[rt].l=tree[rt].r=val[x][col[x]]+<span class="number">1</span>;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> node <span class="title">merge</span><span class="params">(node &amp;x,node &amp;y,<span class="keyword">bool</span> b)</span></span>&#123;</div><div class="line">	node rt=node(x.l,y.r);</div><div class="line">	<span class="keyword">if</span>(b&amp;&amp;x.ret)rt.l=x.l+y.l;</div><div class="line">	<span class="keyword">if</span>(b&amp;&amp;y.ret)rt.r=y.r+x.r;</div><div class="line">	rt.ret=b&amp;&amp;y.ret&amp;&amp;x.ret;</div><div class="line">	<span class="keyword">return</span> rt;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">build</span><span class="params">(<span class="keyword">int</span> rt,<span class="keyword">int</span> l,<span class="keyword">int</span> r)</span></span>&#123;</div><div class="line">	<span class="keyword">if</span>(l==r)&#123;</div><div class="line">		<span class="keyword">int</span> u=dft[l];</div><div class="line">		<span class="keyword">for</span>(<span class="keyword">register</span> <span class="keyword">int</span> v,i=head[u];i;i=E[i].next)</div><div class="line">		<span class="keyword">if</span>(v=E[i].to,v!=fa[u]&amp;&amp;top[u]!=top[v])&#123;</div><div class="line">				build(root[v]=++bct,dfn[v],dfn[v]+sum[v]<span class="number">-1</span>),</div><div class="line">				val[u][col[v]]+=tree[root[v]].l;</div><div class="line">			&#125;</div><div class="line">		maintain(rt,u);</div><div class="line">	&#125;<span class="keyword">else</span>&#123;</div><div class="line">		build(ls[rt]=++bct,l,mid),build(rs[rt]=++bct,mid+<span class="number">1</span>,r);</div><div class="line">		tree[rt]=merge(tree[ls[rt]],tree[rs[rt]],col[dft[mid]]==col[dft[mid+<span class="number">1</span>]]);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">bool</span> <span class="title">judge</span><span class="params">(<span class="keyword">int</span> rt,<span class="keyword">int</span> l,<span class="keyword">int</span> r,<span class="keyword">int</span> L,<span class="keyword">int</span> R,<span class="keyword">int</span> ret=<span class="number">1</span>)</span></span>&#123;</div><div class="line">	<span class="keyword">if</span>(l==r)<span class="keyword">return</span> ret;</div><div class="line">	<span class="keyword">if</span>(L&lt;=mid)ret&amp;=judge(ls[rt],l,mid,L,R);</div><div class="line">	<span class="keyword">if</span>(mid&lt;R)ret&amp;=judge(rs[rt],mid+<span class="number">1</span>,r,L,R);</div><div class="line">	<span class="keyword">if</span>(L&lt;=mid&amp;&amp;R&gt;mid)ret&amp;=col[dft[mid]]==col[dft[mid+<span class="number">1</span>]];</div><div class="line">	<span class="keyword">return</span> ret;</div><div class="line">&#125;</div><div class="line"><span class="built_in">deque</span>&lt;<span class="keyword">int</span>&gt; Q;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">findpath</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">bool</span> flag)</span></span>&#123;</div><div class="line">	Q.clear();</div><div class="line">	<span class="keyword">while</span>(x)&#123;</div><div class="line">		<span class="keyword">int</span> f=top[x];</div><div class="line">		<span class="keyword">if</span>(flag)&#123;</div><div class="line">			<span class="keyword">if</span>(!judge(root[f],dfn[f],dfn[x]+sum[f]<span class="number">-1</span>,dfn[f],dfn[x])||col[fa[f]]!=col[f]||!fa[f])&#123;</div><div class="line">				Q.push_front(x),Q.push_front(f);<span class="keyword">break</span>;</div><div class="line">			&#125;</div><div class="line">		&#125;<span class="keyword">else</span> Q.push_front(x),Q.push_front(f);</div><div class="line">		x=fa[f];</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">int</span> rt,<span class="keyword">int</span> l,<span class="keyword">int</span> r,<span class="keyword">int</span> x)</span></span>&#123;</div><div class="line">	<span class="keyword">if</span>(l==r)&#123;</div><div class="line">		<span class="keyword">int</span> f=dft[l];</div><div class="line">		<span class="keyword">if</span>(x+<span class="number">2</span>&lt;Q.size())&#123;</div><div class="line">			<span class="keyword">int</span> t=Q[x+<span class="number">1</span>];</div><div class="line">            val[f][col[t]]-=tree[root[t]].l;</div><div class="line">            update(root[t],dfn[t],dfn[t]+sum[t]<span class="number">-1</span>,x+<span class="number">2</span>);</div><div class="line">            val[f][col[t]]+=tree[root[t]].l;</div><div class="line">		&#125;<span class="keyword">else</span> col[f]=<span class="number">1</span>-col[f];</div><div class="line">		maintain(rt,f);</div><div class="line">	&#125;<span class="keyword">else</span>&#123;</div><div class="line">		<span class="keyword">if</span>(dfn[Q[x]]&lt;=mid)update(ls[rt],l,mid,x);</div><div class="line">        <span class="keyword">else</span> update(rs[rt],mid+<span class="number">1</span>,r,x);</div><div class="line">        tree[rt]=merge(tree[ls[rt]],tree[rs[rt]],col[dft[mid]]==col[dft[mid+<span class="number">1</span>]]);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">query</span><span class="params">(<span class="keyword">int</span> rt,<span class="keyword">int</span> l,<span class="keyword">int</span> r,<span class="keyword">int</span> x,<span class="keyword">bool</span> &amp;L,<span class="keyword">bool</span> &amp;R,<span class="keyword">int</span> res=<span class="number">0</span>)</span></span>&#123;</div><div class="line">	<span class="keyword">if</span>(l==r)<span class="keyword">return</span> tree[rt].l;</div><div class="line">	<span class="keyword">if</span>(dfn[Q[x]]&lt;=mid)&#123;</div><div class="line">		res+=query(ls[rt],l,mid,x,L,R);</div><div class="line">        <span class="keyword">if</span>(R&amp;&amp;col[dft[mid+<span class="number">1</span>]]==col[dft[mid]])res+=tree[rs[rt]].l;</div><div class="line">        R=R&amp;&amp;tree[rs[rt]].ret&amp;&amp;col[dft[mid+<span class="number">1</span>]]==col[dft[mid]];</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">        res+=query(rs[rt],mid+<span class="number">1</span>,r,x,L,R);</div><div class="line">        <span class="keyword">if</span>(L&amp;&amp;col[dft[mid+<span class="number">1</span>]]==col[dft[mid]])res+=tree[ls[rt]].r;</div><div class="line">        L=L&amp;&amp;tree[ls[rt]].ret&amp;&amp;col[dft[mid+<span class="number">1</span>]]==col[dft[mid]];</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> res;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">change</span><span class="params">(<span class="keyword">int</span> u)</span></span>&#123;</div><div class="line">	findpath(u,<span class="number">0</span>);</div><div class="line">	update(<span class="number">1</span>,<span class="number">1</span>,sum[<span class="number">1</span>],<span class="number">1</span>);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">ask</span><span class="params">(<span class="keyword">int</span> u)</span></span>&#123;</div><div class="line">	findpath(u,<span class="number">1</span>),u=Q[<span class="number">0</span>];</div><div class="line">	<span class="built_in">printf</span>(<span class="string">"%d\n"</span>,query(root[u],dfn[u],dfn[u]+sum[u]<span class="number">-1</span>,<span class="number">1</span>,G=<span class="number">1</span>,H=<span class="number">1</span>));</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">int</span> &amp;res)</span></span>&#123;</div><div class="line">	<span class="keyword">static</span> <span class="keyword">char</span> ch;<span class="keyword">int</span> flag=<span class="number">1</span>;</div><div class="line">	<span class="keyword">while</span>((ch=getchar())&lt;<span class="string">'0'</span>||ch&gt;<span class="string">'9'</span>)<span class="keyword">if</span>(ch==<span class="string">'-'</span>)flag=<span class="number">-1</span>;res=ch<span class="number">-48</span>;</div><div class="line">	<span class="keyword">while</span>((ch=getchar())&gt;=<span class="string">'0'</span>&amp;&amp;ch&lt;=<span class="string">'9'</span>)res=res*<span class="number">10</span>+ch<span class="number">-48</span>;res*=flag;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</div><div class="line">	read(n);</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">register</span> <span class="keyword">int</span> i=<span class="number">1</span>;i&lt;n;i++)read(x),read(y),addedge(x,y);</div><div class="line">	read(q),dfsf(<span class="number">1</span>),dfss(<span class="number">1</span>,<span class="number">1</span>);</div><div class="line">	build(root[<span class="number">1</span>]=++bct,<span class="number">1</span>,sum[<span class="number">1</span>]);</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">register</span> <span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=q;++i)&#123;</div><div class="line">		read(x),read(y);</div><div class="line">		<span class="keyword">if</span>(x)change(y);</div><div class="line">		<span class="keyword">else</span> ask(y);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>

    
    
    

  </section>
</article>
  
    <article class="post no-title">

  
  <time>
    Sep 25, 2017
  </time>
  <section class="content">
	  <p>这道题并不是真正的QTree，真正的QTree系列中QTree3为<a href="http://blog.csdn.net/lemonoil/article/details/74682409" target="_blank" rel="external">query on a tree again！</a></p>
<html><br><body><br><center><h2>1803: Spoj1487 Query on a tree III</h2><span class="green">Time Limit: </span>1 Sec&nbsp;&nbsp;<span class="green">Memory Limit: </span>64 MB<br><span class="green">Submit: </span>579&nbsp;&nbsp;<span class="green">Solved: </span>260<br>[<a href="submitpage.php?id=1803">Submit</a>][<a href="problemstatus.php?id=1803">Status</a>][<a href="bbs.php?id=1803">Discuss</a>]</center><h2>Description</h2><div class="content">You are given a node-labeled rooted tree with n nodes.<br><br>Define the query (x, k): Find the node whose label is k-th largest in the subtree of the node x. Assume no two nodes have the same labels.<br><br><br><br></div><h2>Input</h2><div class="content">The first line contains one integer n (1 &lt;= n &lt;= 10^5). The next line contains n integers li (0 &lt;= li &lt;= 109) which denotes the label of the i-th node.<br><br>Each line of the following n - 1 lines contains two integers u, v. They denote there is an edge between node u and node v. Node 1 is the root of the tree.<br><br>The next line contains one integer m (1 &lt;= m &lt;= 10^4) which denotes the number of the queries. Each line of the next m contains two integers x, k. (k &lt;= the total node number in the subtree of x)<br><br><br><br></div><h2>Output</h2><div class="content"><br>For each query (x, k), output the index of the node whose label is the k-th largest in the subtree of the node x.<br></div><h2>Sample Input</h2><br>            <div class="content"><span class="sampledata">5<br><br>1 3 5 2 7<br><br>1 2<br><br>2 3<br><br>1 4<br><br>3 5<br><br>4<br><br>2 3<br><br>4 1<br><br>3 2<br><br>3 2<br><br><br><br></span></div><h2>Sample Output</h2><br>            <div class="content"><span class="sampledata"><br><br>5<br><br>4<br><br>5<br><br>5<br><br><br><br><br><br><br><br><br><br></span></div><h2>HINT</h2><br>            <div class="content"><p><br><br>Amber的play with tree系列的题…. <br><br></p></div><h2>Source</h2><br>            <div class="content"><p><a href="problemset.php?search="></a></p></div><center>[<a href="submitpage.php?id=1803">Submit</a>][<a href="problemstatus.php?id=1803">Status</a>][<a href="bbs.php?id=1803">Discuss</a>]</center>﻿<br><br><br></body><br></html>

<p>dfs序+主席树裸题<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;algorithm&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstring&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstdio&gt;</span></span></div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> N 100005</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> logN 30</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> mid ((l+r)&gt;&gt;1)</span></div><div class="line"><span class="keyword">int</span> n,m,x,y,k,ans,a[N],b[N],mp[N],tot,head[N],in[N],out[N];</div><div class="line"><span class="keyword">int</span> cnt,ls[N*logN],rs[N*logN],root[N],sz,dfn[N],sum[N*logN];</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">data</span>&#123;</span></div><div class="line">    <span class="keyword">int</span> next,to;</div><div class="line">&#125;E[N&lt;&lt;<span class="number">1</span>];</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">binary_search</span><span class="params">(<span class="keyword">int</span> x)</span></span>&#123;</div><div class="line">    <span class="keyword">int</span> l=<span class="number">1</span>,r=n,ret;</div><div class="line">    <span class="keyword">while</span>(l&lt;=r)</div><div class="line">        <span class="keyword">if</span>(b[mid]&lt;=x)ret=mid,l=mid+<span class="number">1</span>;</div><div class="line">        <span class="keyword">else</span> r=mid<span class="number">-1</span>;</div><div class="line">    <span class="keyword">return</span> ret;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">addedge</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> y)</span></span>&#123;</div><div class="line">    E[++tot].next=head[x],head[x]=tot,E[tot].to=y;</div><div class="line">    E[++tot].next=head[y],head[y]=tot,E[tot].to=x;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">dfs</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> fa)</span></span>&#123;</div><div class="line">    dfn[in[x]=++cnt]=x;</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">register</span> <span class="keyword">int</span> i=head[x];i;i=E[i].next)</div><div class="line">        <span class="keyword">if</span>(E[i].to!=fa)dfs(E[i].to,x);</div><div class="line">    out[x]=cnt;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">int</span> &amp;rt,<span class="keyword">int</span> l,<span class="keyword">int</span> r,<span class="keyword">int</span> w)</span></span>&#123;</div><div class="line">    sum[++sz]=sum[rt]+<span class="number">1</span>,ls[sz]=ls[rt],rs[sz]=rs[rt],rt=sz;</div><div class="line">    <span class="keyword">if</span>(l==r)<span class="keyword">return</span>;</div><div class="line">    <span class="keyword">if</span>(w&lt;=mid)update(ls[rt],l,mid,w);</div><div class="line">    <span class="keyword">else</span> update(rs[rt],mid+<span class="number">1</span>,r,w);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">query</span><span class="params">(<span class="keyword">int</span> l,<span class="keyword">int</span> r,<span class="keyword">int</span> rl,<span class="keyword">int</span> rr,<span class="keyword">int</span> k)</span></span>&#123;</div><div class="line">    <span class="keyword">if</span>(l==r)<span class="keyword">return</span> l;</div><div class="line">    <span class="keyword">int</span> t=sum[ls[rr]]-sum[ls[rl]];</div><div class="line">    <span class="keyword">if</span>(t&gt;=k)<span class="keyword">return</span> query(l,mid,ls[rl],ls[rr],k);</div><div class="line">    <span class="keyword">else</span> query(mid+<span class="number">1</span>,r,rs[rl],rs[rr],k-t);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">int</span> &amp;res)</span></span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">char</span> ch;<span class="keyword">int</span> flag=<span class="number">1</span>;</div><div class="line">    <span class="keyword">while</span>((ch=getchar())&lt;<span class="string">'0'</span>||ch&gt;<span class="string">'9'</span>)<span class="keyword">if</span>(ch==<span class="string">'-'</span>)flag=<span class="number">-1</span>;res=ch<span class="number">-48</span>;</div><div class="line">    <span class="keyword">while</span>((ch=getchar())&gt;=<span class="string">'0'</span>&amp;&amp;ch&lt;=<span class="string">'9'</span>)res=res*<span class="number">10</span>+ch<span class="number">-48</span>;res*=flag;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</div><div class="line">    read(n);</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">register</span> <span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=n;++i)</div><div class="line">        read(a[i]),b[i]=a[i];</div><div class="line">    sort(b+<span class="number">1</span>,b+n+<span class="number">1</span>);</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">register</span> <span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=n;++i)</div><div class="line">        x=binary_search(a[i]),mp[x]=i,a[i]=x;</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">register</span> <span class="keyword">int</span> i=<span class="number">1</span>;i&lt;n;++i)</div><div class="line">        read(x),read(y),addedge(x,y);</div><div class="line">    dfs(<span class="number">1</span>,<span class="number">0</span>);</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">register</span> <span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=n;++i)</div><div class="line">        update(root[i]=root[i<span class="number">-1</span>],<span class="number">1</span>,n,a[dfn[i]]);</div><div class="line">    read(m);</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">register</span> <span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=m;++i)&#123;</div><div class="line">        read(x),read(k);</div><div class="line">        <span class="keyword">int</span> l=in[x],r=out[x];</div><div class="line">        ans=mp[query(<span class="number">1</span>,n,root[l<span class="number">-1</span>],root[r],k)];</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%d\n"</span>,ans);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>


    
    
    

  </section>
</article>
  
    <article class="post no-title">

  
  <time>
    Sep 25, 2017
  </time>
  <section class="content">
	  <p>4.5hours的艰苦奋斗。。。。。<br>好想爆粗口。。。堆转手写set，树链剖分上加点入set，线段树维护set信息。。我想死。。。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;bits/stdc++.h&gt;</span></span></div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> N=<span class="number">100020</span>,inf=<span class="number">1</span>&lt;&lt;<span class="number">29</span>;</div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="keyword">char</span> cmd[<span class="number">8</span>];</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Set</span>&#123;</span></div><div class="line">	priority_queue&lt;<span class="keyword">int</span>&gt; a,b;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">erase</span><span class="params">(<span class="keyword">int</span> x)</span></span>&#123;b.push(x);&#125;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(<span class="keyword">int</span> x)</span></span>&#123;a.push(x);&#125;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">slnew</span><span class="params">()</span></span>&#123;</div><div class="line">		<span class="keyword">while</span>(!a.empty()&amp;&amp;!b.empty()&amp;&amp;a.top()==b.top())a.pop(),b.pop();</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">int</span> <span class="title">top</span><span class="params">()</span></span>&#123;</div><div class="line">		slnew();<span class="keyword">return</span> a.empty()?-inf:a.top();</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">int</span> <span class="title">query</span><span class="params">()</span></span>&#123;</div><div class="line">		<span class="keyword">int</span> x,y;slnew();</div><div class="line">		<span class="keyword">if</span>(a.empty())<span class="keyword">return</span> -inf;</div><div class="line">		x=a.top(),a.pop(),slnew();</div><div class="line">		y=a.empty()?-inf:x+a.top(),a.push(x);</div><div class="line">		<span class="keyword">return</span> y;</div><div class="line">	&#125;</div><div class="line">&#125;heap[N],lis;</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">data</span>&#123;</span></div><div class="line">    <span class="keyword">int</span> to,next,w;</div><div class="line">&#125;E[N&lt;&lt;<span class="number">1</span>];</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span>&#123;</span></div><div class="line">	<span class="keyword">int</span> L,R,ret;</div><div class="line">	node *ch[<span class="number">2</span>];</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">setting</span><span class="params">(<span class="keyword">int</span> u)</span></span>&#123;</div><div class="line">		ret=heap[u].query();</div><div class="line">		L=R=heap[u].top();</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">update</span><span class="params">(<span class="keyword">int</span> lc,<span class="keyword">int</span> rc,<span class="keyword">int</span> rt)</span></span>;</div><div class="line">&#125;*root[N],pool[N&lt;&lt;<span class="number">2</span>],*pool_tail=pool;</div><div class="line"><span class="keyword">int</span> n,tot,head[N],son[N],sz[N],fa[N],top[N],dfw[N],dfn[N],w[N],cnt;</div><div class="line"><span class="keyword">int</span> dis[N&lt;&lt;<span class="number">2</span>],tail[N],col[N],tal,se,m;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">addedge</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> y,<span class="keyword">int</span> z)</span></span>&#123;</div><div class="line">    E[++tot].to=y,E[tot].next=head[x],E[tot].w=z,head[x]=tot;</div><div class="line">    E[++tot].to=x,E[tot].next=head[y],E[tot].w=z,head[y]=tot;</div><div class="line">&#125;</div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> mid ((rc+lc)&gt;&gt;1)</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">merge</span><span class="params">(node &amp;rt,<span class="keyword">const</span> node &amp;l,<span class="keyword">const</span> node &amp;r,<span class="keyword">int</span> lc,<span class="keyword">int</span> rc)</span></span>&#123;</div><div class="line">	rt.ret=max(l.ret,r.ret);</div><div class="line">	rt.ret=max(rt.ret,l.R+dis[dfw[mid+<span class="number">1</span>]]-dis[dfw[mid]]+r.L);</div><div class="line">	rt.L=max(l.L,dis[dfw[mid+<span class="number">1</span>]]-dis[dfw[lc]]+r.L);</div><div class="line">	rt.R=max(r.R,dis[dfw[rc]]-dis[dfw[mid]]+l.R);</div><div class="line">&#125;</div><div class="line"><span class="keyword">void</span> node::update(<span class="keyword">int</span> lc,<span class="keyword">int</span> rc,<span class="keyword">int</span> rt)&#123;</div><div class="line">	<span class="keyword">if</span>(lc==rc)<span class="keyword">return</span> setting(dfw[rt]);</div><div class="line">	<span class="keyword">if</span>(rt&lt;=mid)ch[<span class="number">0</span>]-&gt;update(lc,mid,rt);</div><div class="line">	<span class="keyword">else</span> ch[<span class="number">1</span>]-&gt;update(mid+<span class="number">1</span>,rc,rt);</div><div class="line">	merge(*<span class="keyword">this</span>,*ch[<span class="number">0</span>],*ch[<span class="number">1</span>],lc,rc);</div><div class="line">&#125;</div><div class="line"><span class="function">node *<span class="title">build</span><span class="params">(<span class="keyword">int</span> lc,<span class="keyword">int</span> rc)</span></span>&#123;</div><div class="line">	node *rt=pool_tail++;</div><div class="line">	<span class="keyword">if</span>(lc==rc)rt-&gt;setting(dfw[lc]);</div><div class="line">	<span class="keyword">else</span>&#123;</div><div class="line">		rt-&gt;ch[<span class="number">0</span>]=build(lc,mid),rt-&gt;ch[<span class="number">1</span>]=build(mid+<span class="number">1</span>,rc);</div><div class="line">		merge(*rt,*rt-&gt;ch[<span class="number">0</span>],*rt-&gt;ch[<span class="number">1</span>],lc,rc);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> rt;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfsf</span><span class="params">(<span class="keyword">int</span> u)</span></span>&#123;</div><div class="line">	col[u]=sz[u]=<span class="number">1</span>;</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> v,i=head[u];i;i=E[i].next)&#123;</div><div class="line">		<span class="keyword">if</span>(v=E[i].to,v!=fa[u])&#123;</div><div class="line">			dis[v]=dis[u]+E[i].w,fa[v]=u,dfsf(v),sz[u]+=sz[v];</div><div class="line">			<span class="keyword">if</span>(sz[son[u]]&lt;sz[v])son[u]=v;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfss</span><span class="params">(<span class="keyword">int</span> u,<span class="keyword">int</span> f)</span></span>&#123;</div><div class="line">	top[u]=f,dfw[dfn[u]=++cnt]=u;</div><div class="line">	tail[f]=max(tail[f],dfn[u]);</div><div class="line">	<span class="keyword">if</span>(son[u])dfss(son[u],f);</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> v,i=head[u];i;i=E[i].next)</div><div class="line">		<span class="keyword">if</span>(v=E[i].to,v!=fa[u]&amp;&amp;v!=son[u])dfss(v,v),</div><div class="line">		heap[u].insert(root[v]-&gt;L+dis[v]-dis[u]);</div><div class="line">	heap[u].insert(<span class="number">0</span>);</div><div class="line">	<span class="keyword">if</span>(top[u]==u)&#123;</div><div class="line">		root[u]=build(dfn[u],tail[u]);</div><div class="line">		lis.insert(root[u]-&gt;ret);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">ask</span><span class="params">(<span class="keyword">int</span> u)</span></span>&#123;</div><div class="line">	<span class="keyword">static</span> <span class="keyword">int</span> anc[<span class="number">22</span>],tc;tc=<span class="number">0</span>;</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=u;i;i=fa[top[i]])anc[tc++]=i;</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=tc<span class="number">-1</span>;i&gt;=<span class="number">0</span>;--i)&#123;</div><div class="line">		lis.erase(root[top[anc[i]]]-&gt;ret);</div><div class="line">		<span class="keyword">if</span>(i)heap[anc[i]].erase(root[top[anc[i<span class="number">-1</span>]]]-&gt;L+dis[top[anc[i<span class="number">-1</span>]]]-dis[anc[i]]);</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span>(col[u])heap[u].insert(<span class="number">0</span>);</div><div class="line">	<span class="keyword">else</span> heap[u].erase(<span class="number">0</span>);</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;tc;++i)&#123;</div><div class="line">		<span class="keyword">int</span> x=anc[i],t=top[x];</div><div class="line">		root[t]-&gt;update(dfn[t],tail[t],dfn[x]);</div><div class="line">		lis.insert(root[t]-&gt;ret);</div><div class="line">		<span class="keyword">if</span>(i+<span class="number">1</span>&lt;tc)heap[anc[i+<span class="number">1</span>]].insert(root[t]-&gt;L+dis[t]-dis[anc[i+<span class="number">1</span>]]);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">int</span> &amp;res)</span></span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">char</span> ch;<span class="keyword">int</span> flag=<span class="number">1</span>;</div><div class="line">    <span class="keyword">while</span>((ch=getchar())&lt;<span class="string">'0'</span>||ch&gt;<span class="string">'9'</span>)<span class="keyword">if</span>(ch==<span class="string">'-'</span>)flag=<span class="number">-1</span>;res=ch<span class="number">-48</span>;</div><div class="line">    <span class="keyword">while</span>((ch=getchar())&gt;=<span class="string">'0'</span>&amp;&amp;ch&lt;=<span class="string">'9'</span>)res=res*<span class="number">10</span>+ch<span class="number">-48</span>;res*=flag;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</div><div class="line">	read(n);</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> u,v,z,i=<span class="number">1</span>;i&lt;n;i++)read(u),read(v),read(z),addedge(u,v,z);</div><div class="line">	dfsf(<span class="number">1</span>),dfss(<span class="number">1</span>,<span class="number">1</span>),read(m),tal=n;</div><div class="line">    <span class="keyword">while</span>(m--)&#123;</div><div class="line">    	<span class="built_in">scanf</span>(<span class="string">"%s"</span>,cmd);</div><div class="line">        <span class="keyword">if</span>(cmd[<span class="number">0</span>]==<span class="string">'A'</span>)&#123;</div><div class="line">        	<span class="keyword">if</span>(tal==<span class="number">0</span>)<span class="built_in">puts</span>(<span class="string">"They have disappeared."</span>);</div><div class="line">        	<span class="keyword">else</span> <span class="keyword">if</span>(tal==<span class="number">1</span>)<span class="built_in">puts</span>(<span class="string">"0"</span>);</div><div class="line">        	<span class="keyword">else</span> <span class="built_in">printf</span>(<span class="string">"%d\n"</span>,max(lis.top(),<span class="number">0</span>));</div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">        	read(se);</div><div class="line">        	<span class="keyword">if</span>(!(col[se]^=<span class="number">1</span>))--tal;</div><div class="line">			<span class="keyword">else</span> ++tal;ask(se);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这才第4道，不知道之后的5~7会如何的GG。。。</p>


    
    
    

  </section>
</article>
  
    <article class="post no-title">

  
  <time>
    Sep 25, 2017
  </time>
  <section class="content">
	  <p>仍然是上一道题的模板，<br>这道题重点是要学会倍增来查找路径上的点。即kfa()<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;algorithm&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstring&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstdio&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cmath&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> clr(x) memset((x),0,sizeof(x))</span></div><div class="line"><span class="keyword">const</span> <span class="keyword">int</span> N=<span class="number">200020</span>,inf=~<span class="number">0U</span>&gt;&gt;<span class="number">1</span>;</div><div class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</div><div class="line"><span class="keyword">char</span> cmd[<span class="number">10</span>];</div><div class="line"><span class="class"><span class="keyword">struct</span> <span class="title">data</span>&#123;</span></div><div class="line">    <span class="keyword">int</span> to,next,w;</div><div class="line">&#125;E[N&lt;&lt;<span class="number">1</span>];</div><div class="line"><span class="keyword">int</span> n,tot,head[N],deep[N],son[N],sz[N],top[N],dfw[N],mx[N&lt;&lt;<span class="number">2</span>],ft[<span class="number">24</span>][N],dis[N];</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">addedge</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> y,<span class="keyword">int</span> z)</span></span>&#123;</div><div class="line">    E[tot].to=y,E[tot].next=head[x],E[tot].w=z,head[x]=tot++;</div><div class="line">    E[tot].to=x,E[tot].next=head[y],E[tot].w=z,head[y]=tot++;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">dfsf</span><span class="params">(<span class="keyword">int</span> u)</span></span>&#123;</div><div class="line">	sz[u]=<span class="number">1</span>;</div><div class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> v,i=head[u];~i;i=E[i].next)&#123;</div><div class="line">		<span class="keyword">if</span>(v=E[i].to,v!=ft[<span class="number">0</span>][u])&#123;</div><div class="line">			dis[v]=E[i].w+dis[u],deep[v]=deep[u]+<span class="number">1</span>,ft[<span class="number">0</span>][v]=u,dfsf(v),sz[u]+=sz[v];</div><div class="line">			<span class="keyword">if</span>(sz[son[u]]&lt;sz[v])son[u]=v;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment">void dfss(int u,int f)&#123;</span></div><div class="line"><span class="comment">	top[u]=f,dfn[u]=++cnt,dfw[cnt]=u;</span></div><div class="line"><span class="comment">	if(son[u])dfss(son[u],f);</span></div><div class="line"><span class="comment">	for(int v,i=head[u];~i;i=E[i].next)</span></div><div class="line"><span class="comment">		if(v=E[i].to,v!=fa[u]&amp;&amp;v!=son[u])dfss(v,v);</span></div><div class="line"><span class="comment">&#125;</span></div><div class="line"><span class="comment">int lca(int u,int v)&#123;</span></div><div class="line"><span class="comment">	while(top[u]!=top[v])&#123;</span></div><div class="line"><span class="comment">		if(deep[top[u]]&gt;deep[top[v]])swap(u,v);</span></div><div class="line"><span class="comment">        v=fa[top[v]];</span></div><div class="line"><span class="comment">	&#125;</span></div><div class="line"><span class="comment">	if(deep[u]&gt;deep[v])swap(u,v);</span></div><div class="line"><span class="comment">	return u;</span></div><div class="line"><span class="comment">&#125;</span></div><div class="line"><span class="comment">*/</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">lca_init</span><span class="params">()</span> </span>&#123;  </div><div class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> k=<span class="number">0</span>;k &lt;<span class="number">21</span>;++k)&#123;  </div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">1</span>;i&lt;=n;++i)&#123;  </div><div class="line">            <span class="keyword">if</span>(ft[k][i]==<span class="number">0</span>)ft[k+<span class="number">1</span>][i]=<span class="number">0</span>;  </div><div class="line">            <span class="keyword">else</span> ft[k+<span class="number">1</span>][i]=ft[k][ft[k][i]];  </div><div class="line">        &#125;  </div><div class="line">    &#125;  </div><div class="line">&#125;  </div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">lca</span><span class="params">(<span class="keyword">int</span> u,<span class="keyword">int</span> v)</span> </span>&#123;  </div><div class="line">    <span class="keyword">if</span>(deep[u]&gt;deep[v])swap(u,v);  </div><div class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> k=<span class="number">0</span>;k&lt;<span class="number">22</span>;++k)  </div><div class="line">        <span class="keyword">if</span>((deep[v]-deep[u])&gt;&gt;k&amp;<span class="number">1</span>)v=ft[k][v];</div><div class="line">    <span class="keyword">if</span>(v==u)<span class="keyword">return</span> u;  </div><div class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> k=<span class="number">21</span>;k&gt;=<span class="number">0</span>;--k)  </div><div class="line">        <span class="keyword">if</span>(ft[k][u]!=ft[k][v])  </div><div class="line">            u=ft[k][u],v=ft[k][v];  </div><div class="line">    <span class="keyword">return</span> ft[<span class="number">0</span>][u];  </div><div class="line">&#125;  </div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">kfa</span><span class="params">(<span class="keyword">int</span> u,<span class="keyword">int</span> k)</span> </span>&#123;  </div><div class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">22</span>;++i)  </div><div class="line">        <span class="keyword">if</span>(k&gt;&gt;i&amp;<span class="number">1</span>)u=ft[i][u];  </div><div class="line">    <span class="keyword">return</span> u;</div><div class="line">&#125;  </div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span>&#123;</div><div class="line">	tot=<span class="number">0</span>;</div><div class="line">	<span class="built_in">memset</span>(head,<span class="number">-1</span>,<span class="keyword">sizeof</span>(head)),clr(deep),clr(sz),clr(son),clr(dfw),clr(ft);</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">read</span><span class="params">(<span class="keyword">int</span> &amp;res)</span></span>&#123;</div><div class="line">    <span class="keyword">static</span> <span class="keyword">char</span> ch;<span class="keyword">int</span> flag=<span class="number">1</span>;</div><div class="line">    <span class="keyword">while</span>((ch=getchar())&lt;<span class="string">'0'</span>||ch&gt;<span class="string">'9'</span>)<span class="keyword">if</span>(ch==<span class="string">'-'</span>)flag=<span class="number">-1</span>;res=ch<span class="number">-48</span>;</div><div class="line">    <span class="keyword">while</span>((ch=getchar())&gt;=<span class="string">'0'</span>&amp;&amp;ch&lt;=<span class="string">'9'</span>)res=res*<span class="number">10</span>+ch<span class="number">-48</span>;res*=flag;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</div><div class="line">	<span class="keyword">int</span> t;read(t);</div><div class="line">	<span class="keyword">while</span>(t--)&#123;</div><div class="line">		init();</div><div class="line">		read(n);</div><div class="line">	    <span class="keyword">for</span>(<span class="keyword">int</span> u,v,z,i=<span class="number">1</span>;i&lt;n;i++)read(u),read(v),read(z),addedge(u,v,z);</div><div class="line">		ft[<span class="number">0</span>][<span class="number">1</span>]=<span class="number">-1</span>,dfsf(<span class="number">1</span>),lca_init();</div><div class="line">	    <span class="keyword">while</span>(<span class="built_in">scanf</span>(<span class="string">"%s"</span>,cmd)&amp;&amp;cmd[<span class="number">1</span>]!=<span class="string">'O'</span>)&#123;</div><div class="line">	    	<span class="keyword">int</span> s,t,q,x;</div><div class="line">	        read(s),read(t),q=lca(s,t);</div><div class="line">	        <span class="keyword">if</span>(cmd[<span class="number">0</span>]==<span class="string">'K'</span>)&#123;</div><div class="line">	        	<span class="keyword">int</span> w;read(w);</div><div class="line">	        	x=deep[s]-deep[q];</div><div class="line">	        	<span class="keyword">if</span>(x+<span class="number">1</span>&gt;=w)</div><div class="line">	        		<span class="built_in">printf</span>(<span class="string">"%d\n"</span>, kfa(s, w - <span class="number">1</span>));</div><div class="line">	        	<span class="keyword">else</span>  </div><div class="line">                    <span class="built_in">printf</span>(<span class="string">"%d\n"</span>, kfa(t, deep[t] + deep[s] - <span class="number">2</span> * deep[q] + <span class="number">1</span> - w));  </div><div class="line">	        &#125;</div><div class="line">	        <span class="keyword">else</span> <span class="built_in">printf</span>(<span class="string">"%d\n"</span>,dis[s]+dis[t]-dis[q]*<span class="number">2</span>);</div><div class="line">	    &#125;</div><div class="line">	&#125;</div><div class="line">    <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>


    
    
    

  </section>
</article>
  
</section>


  <nav id="page-nav">
    
    
    <a class="next" rel="next" href="/archives/2017/09/page/2/">
      <span class="text">Next</span>
      <span class="icon icon-chevron-right"></span>
    </a>
    
  </nav>
  


      <script>setLoadingBarProgress(60);</script>
    </main>
    
    <footer id="footer" class="clearfix">
  
  
	<div class="search">
	  <form name="searchform" id="searchform" class="u-search-form">
	    <input type="text" id="searchinput" class="u-search-input" placeholder="Looking for something?" />
	    <button type="submit" id="u-search-btn-submit" class="u-search-btn-submit">
	      <span class="icon icon-search"></span>
	    </button>
	  </form>
	</div>
	

	<div class="social-wrapper">
  	
      
        <a href="https://github.com/artchen" class="social github"
          target="_blank" rel="external">
          <span class="icon icon-github"></span>
        </a>
      
        <a href="https://twitter.com/otakism" class="social twitter"
          target="_blank" rel="external">
          <span class="icon icon-twitter"></span>
        </a>
      
        <a href="/atom.xml" class="social rss"
          target="_blank" rel="external">
          <span class="icon icon-rss"></span>
        </a>
      
        <a href="https://plus.google.com/+ArtChenOtakism/posts" class="social google"
          target="_blank" rel="external">
          <span class="icon icon-google"></span>
        </a>
      
        <a href="http://weibo.com/otakism/" class="social sina-weibo"
          target="_blank" rel="external">
          <span class="icon icon-sina-weibo"></span>
        </a>
      
    
  </div>
  
  <div>Theme <span class="codename">Typescript</span> designed by <a href="http://rakugaki.me/" target="_blank">Art Chen</a>.</div>
  <div>&copy; <a href="/">PIVIX</a></div>
  
</footer>


    <script>setLoadingBarProgress(80);</script>
    
  </div>

  
<script>
  var disqus_shortname = 'https://lemonoilP.github.io';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>




<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script>window.jQuery || document.write('<script src="/js/jquery.min.js"><\/script>')</script>

<script src="/js/jquery.fitvids.js"></script>
<script>
	var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
	var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
	var ALGOLIA_API_KEY = "";
	var ALGOLIA_APP_ID = "";
	var ALGOLIA_INDEX_NAME = "";
  var AZURE_SERVICE_NAME = "";
  var AZURE_INDEX_NAME = "";
  var AZURE_QUERY_KEY = "";
  var BAIDU_API_ID = "";
  var SEARCH_SERVICE = "google";
</script>
<script src="/js/search.js"></script>
<script src="/js/app.js"></script>


  <script>setLoadingBarProgress(100);</script>
  
</body>
</html>
